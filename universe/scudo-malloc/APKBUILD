pkgname=scudo-malloc
# tied to llvm version
pkgver=18.1.6
pkgrel=0
pkgdesc="Standalone scudo malloc from compiler-rt"
url="https://llvm.org"
arch="all"
license="Apache-2.0 WITH LLVM-exception"
depends_dev="$pkgname=$pkgver-r$pkgrel"
makedepends="linux-headers"
checkdepends="gtest-dev"
subpackages="$pkgname-static $pkgname-dev"
source="https://github.com/llvm/llvm-project/releases/download/llvmorg-${pkgver//_/-}/compiler-rt-${pkgver//_/}.src.tar.xz
	0001-Add-makefile.patch
	"
builddir="$srcdir/compiler-rt-${pkgver//_/}.src/lib/scudo/standalone"

build() {
	local cflags_crc32=
	unset CXXFLAGS
	case "$CARCH" in
		aarch64)
			# this has broken emulation in aarch64 qemu (incl qemu-user),
			# which causes it to abort instantly
			CXXFLAGS="-DSCUDO_DISABLE_TBI"
			cflags_crc32="-march=armv8-a+crc"
			;;
		x86*)	cflags_crc32="-mcrc32"
			;;
	esac

	msg "building libscudo"
	make CXXFLAGS="$CXXFLAGS" CXXFLAGS_crc32="$cflags_crc32" TESTS="$(want_check && echo yes || echo no)"
}

check() {
	make test
}

package() {
	install -Dm755 libscudo.so -t "$pkgdir"/usr/lib/
	install -Dm644 libscudo.a -t "$pkgdir"/usr/lib/
	install -Dm644 include/scudo/interface.h -t "$pkgdir"/usr/include/scudo/
}

sha512sums="
0594b6d21ec51b454fd120a5a9035640b92779694efbfe52e3353152b0e00078501017817c8bb076a73cf585a0469672ee958207be7deca3f0045942616b4bd8  compiler-rt-18.1.6.src.tar.xz
1102a512adde2ef31aafa6011a4293d5fa361aa920f88ac20599aab84711e973315e6f6719631be11007aea869ae700e34ed57c7dc7724e8aacbc5b493632849  0001-Add-makefile.patch
"
