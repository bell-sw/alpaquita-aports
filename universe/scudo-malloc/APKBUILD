pkgname=scudo-malloc
# tied to llvm version
pkgver=17.0.3
pkgrel=0
pkgdesc="Standalone scudo malloc from compiler-rt"
url="https://llvm.org"
arch="all"
license="Apache-2.0 WITH LLVM-exception"
depends_dev="$pkgname=$pkgver-r$pkgrel"
makedepends="linux-headers"
checkdepends="gtest-dev"
subpackages="$pkgname-static $pkgname-dev"
source="https://github.com/llvm/llvm-project/releases/download/llvmorg-${pkgver//_/-}/compiler-rt-${pkgver//_/}.src.tar.xz
	0001-Add-makefile.patch
	0001-scudo-Detach-the-hooks-from-Scudo-s-internal-impleme.patch
	"
builddir="$srcdir/compiler-rt-${pkgver//_/}.src/lib/scudo/standalone"

build() {
	local cflags_crc32=
	unset CXXFLAGS
	case "$CARCH" in
		aarch64)
			# this has broken emulation in aarch64 qemu (incl qemu-user),
			# which causes it to abort instantly
			CXXFLAGS="-DSCUDO_DISABLE_TBI"
			cflags_crc32="-march=armv8-a+crc"
			;;
		x86*)	cflags_crc32="-mcrc32"
			;;
	esac

	msg "building libscudo"
	make CXXFLAGS="$CXXFLAGS" CXXFLAGS_crc32="$cflags_crc32"
}

check() {
	make test
}

package() {
	install -Dm755 libscudo.so -t "$pkgdir"/usr/lib/
	install -Dm644 libscudo.a -t "$pkgdir"/usr/lib/
	install -Dm644 include/scudo/interface.h -t "$pkgdir"/usr/include/scudo/
}

sha512sums="
514f7c6827882c68b5e6ac0970b9cfe07786911d4939668ce0a3d96ad2482a9b03581fe3df68826fe900dae1044a341de2d7b131865d7fdd15485405396d5fe5  compiler-rt-17.0.3.src.tar.xz
e7e2d434fcdae64469ee2b4faced12f05991eff3b98fbebb8dd138b412921c3506b848dea7cd5d8a8bfdaa345dec06e0ed63f7401ecde2e9006af9630dea02d8  0001-Add-makefile.patch
366aff393f2e4d0798e28e504f1d06d7a9fd56f3e4093e3057129a69a2ec9f0acbb789138ab52a006eab4f1f2008970fe283218c75f562076475f913e307e963  0001-scudo-Detach-the-hooks-from-Scudo-s-internal-impleme.patch
"
