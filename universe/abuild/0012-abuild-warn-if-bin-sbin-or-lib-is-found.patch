From 5292cb3a0d1c6393b83da709a71bcff2d218a886 Mon Sep 17 00:00:00 2001
From: Dmitry Klochkov <dmitry.klochkov@bell-sw.com>
Date: Fri, 2 Sep 2022 19:20:01 +0300
Subject: [PATCH] abuild: warn if /bin, /sbin or /lib is found

---
 abuild.in                                     | 11 ++++++
 tests/abuild.bats                             | 19 ++++++++++
 .../alpaquita-invalid-fhs/APKBUILD.in         | 35 +++++++++++++++++++
 3 files changed, 65 insertions(+)
 create mode 100644 tests/testrepo/alpaquita-invalid-fhs/APKBUILD.in

diff --git a/abuild.in b/abuild.in
index f2faa74..0010af4 100644
--- a/abuild.in
+++ b/abuild.in
@@ -819,6 +819,17 @@ postcheck() {
 		fi
 	fi
 
+	# checking for Alpaquita FHS compat
+	for i in bin sbin lib; do
+		if [ -e "$dir/$i" ]; then
+			# ignore if it is a valid symlink
+			[ -h "$dir/$i" ] && [ $(readlink "$dir/$i") = "usr/$i" ] \
+				&& continue
+
+			warning "Packages must not put anything under /$i, use /usr/$i instead"
+		fi
+	done
+
 	# remove *.la files if libtool is not set
 	if ! options_has "libtool"; then
 		find "$dir" -name '*.la' -type f -delete
diff --git a/tests/abuild.bats b/tests/abuild.bats
index adb96ae..70d8b4a 100644
--- a/tests/abuild.bats
+++ b/tests/abuild.bats
@@ -218,3 +218,22 @@ teardown() {
 	[[ $output == *"is not an openrc"* ]]
 	[[ $status -ne 0 ]]
 }
+
+@test "abuild: alpaquita: test check for /bin, /sbin, /lib" {
+	cd testrepo/alpaquita-invalid-fhs
+	msg_fmt='Packages must not put anything under /%s, use /usr/%s instead'
+
+	sed 's#@ftype@#dir#' APKBUILD.in >APKBUILD
+	run $ABUILD all
+	[[ $output == *"$(printf "$msg_fmt" bin{,})"* ]]
+	[[ $output == *"$(printf "$msg_fmt" sbin{,})"* ]]
+	[[ $output == *"$(printf "$msg_fmt" lib{,})"* ]]
+	[[ $status -eq 0 ]]
+
+	sed 's#@ftype@#link#' APKBUILD.in >APKBUILD
+	run $ABUILD cleanpkg all
+	[[ $output != *"$(printf "$msg_fmt" bin{,})"* ]]
+	[[ $output != *"$(printf "$msg_fmt" sbin{,})"* ]]
+	[[ $output != *"$(printf "$msg_fmt" lib{,})"* ]]
+	[[ $status -eq 0 ]]
+}
diff --git a/tests/testrepo/alpaquita-invalid-fhs/APKBUILD.in b/tests/testrepo/alpaquita-invalid-fhs/APKBUILD.in
new file mode 100644
index 0000000..906b28c
--- /dev/null
+++ b/tests/testrepo/alpaquita-invalid-fhs/APKBUILD.in
@@ -0,0 +1,35 @@
+# Maintainer: BellSoft <info@bell-sw.com>
+
+# test package
+pkgname="alpaquita-invalid-fhs"
+pkgver="1.0"
+pkgrel=0
+pkgdesc="Dummy test package"
+url="https://bell-sw.com"
+arch="noarch"
+license="MIT"
+
+prepare() {
+	mkdir -p "$builddir"
+}
+
+build() {
+	local i; for i in bin sbin lib; do
+		case @ftype@ in
+		link)
+			mkdir -p usr/$i
+			ln -s usr/$i $i
+			;;
+		dir) mkdir $i;;
+		esac
+	done
+}
+
+check() {
+	true
+}
+
+package() {
+	mkdir -p "$pkgdir"
+	cp -r * "$pkgdir"/
+}
-- 
2.36.2

