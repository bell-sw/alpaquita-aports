From 0a1015c7428af0b900f886285188343164df3b6c Mon Sep 17 00:00:00 2001
From: Alexey Kodanev <aleksei.kodanev@bell-sw.com>
Date: Tue, 16 Aug 2022 16:31:08 +0300
Subject: [PATCH] abuild.conf: enable stack-protector-strong and
 _FORTIFY_SOURCE=2

Add hardening checks using annobin/annocheck. The !annobin option
can be set to disable the test and building with the plugin.
---
 abuild.conf                    |  2 +-
 abuild.in                      | 40 ++++++++++++++++++++++++++++++++--
 tests/testrepo/dbgpkg/APKBUILD |  7 +++++-
 3 files changed, 45 insertions(+), 4 deletions(-)

diff --git a/abuild.conf b/abuild.conf
index 4ff34f1..c5f50b4 100644
--- a/abuild.conf
+++ b/abuild.conf
@@ -1,4 +1,4 @@
-export CFLAGS="-Os -fomit-frame-pointer"
+export CFLAGS="-fplugin=annobin -Os -fomit-frame-pointer -fstack-protector-strong -D_FORTIFY_SOURCE=2"
 export CXXFLAGS="$CFLAGS"
 export CPPFLAGS="$CFLAGS"
 export LDFLAGS="-Wl,--as-needed,-O1,--sort-common"
diff --git a/abuild.in b/abuild.in
index 76cd77b..5052787 100644
--- a/abuild.in
+++ b/abuild.in
@@ -1904,7 +1904,9 @@ default_dbg() {
 		if ! [ -e "$pkgbasedir/.dbg-tmp/$ino" ]; then
 			local tmp=$pkgbasedir/.dbg-tmp/${src##*/}
 			${CROSS_COMPILE}objcopy --only-keep-debug "$src" "$dst"
-			${CROSS_COMPILE}objcopy --add-gnu-debuglink="$dst" --strip-unneeded -R .comment "$src" "$tmp"
+			${CROSS_COMPILE}objcopy --add-gnu-debuglink="$dst" --strip-unneeded \
+				-R .comment -R .gnu.build.attributes* \
+				"$src" "$tmp"
 			# preserve attributes, links
 			cat "$tmp" > "$src"
 			rm "$tmp"
@@ -2096,6 +2098,7 @@ rootpkg() {
 
 	do_fakeroot "$abuild_path" $forceroot $color_opt $keep_build \
 		package \
+		hardening_check \
 		prepare_subpackages \
 		prepare_language_packs \
 		prepare_package \
@@ -2476,13 +2479,26 @@ stripbin() {
 
 		[ "$osabi" != "STANDALONE" ] || continue
 		local XATTR=$(getfattr --match="" --dump "${filename}")
-		"${stripcmd}" "${filename}"
+		"${stripcmd}" --remove-section=.gnu.build.attributes* "${filename}"
 		if [ -n "$XATTR" ]; then
 			echo "$XATTR" | "$SETFATTR" --restore=-
 		fi
 	done
 }
 
+hardening_check()
+{
+	if options_has "!annobin" || [ "${subpkgarch:-$pkgarch}" = "noarch" ]; then
+		return 0
+	fi
+
+	cd "${subpkgdir:-$pkgdir}" || return 1
+
+	cd $pkgdir
+	find . -type f | xargs annocheck --ignore-unknown --ignore-links
+	cd -
+}
+
 # simply list target apks
 listpkg() {
 	local name
@@ -2806,6 +2822,26 @@ if [ -n "$DEBUG" ] || subpackage_types_has "dbg"; then
 	options="$options !strip"
 fi
 
+remove_cflags()
+{
+	local f="$@"
+	export CFLAGS="${CFLAGS/$f/}"
+	export CXXFLAGS="${CXXFLAGS/$f/}"
+	export CPPFLAGS="${CPPFLAGS/$f/}"
+}
+
+if options_has "!annobin" || [ -n "$ABUILD_DISABLE_ANNOBIN" ] ; then
+	remove_cflags "-fplugin=annobin"
+fi
+
+if options_has "!stackprot"; then
+	remove_cflags "-fstack-protector-strong"
+fi
+
+if options_has "!fortify"; then
+	remove_cflags "-D_FORTIFY_SOURCE=2"
+fi
+
 if [ -n "$subpkgname" ]; then
 	# If we are handling a sub package then reset subpackages and install
 	origsubpackages="$subpackages"
diff --git a/tests/testrepo/dbgpkg/APKBUILD b/tests/testrepo/dbgpkg/APKBUILD
index e090c35..e3c8b7b 100644
--- a/tests/testrepo/dbgpkg/APKBUILD
+++ b/tests/testrepo/dbgpkg/APKBUILD
@@ -18,7 +18,12 @@ prepare() {
 }
 
 build() {
-	${CC:-gcc} -o hello hello.c
+	${CC:-gcc} \
+		-Os \
+		-fplugin=annobin \
+		-fstack-protector-strong \
+		-D_FORTIFY_SOURCE=2 \
+		-o hello hello.c
 }
 
 check() {
-- 
2.25.1

