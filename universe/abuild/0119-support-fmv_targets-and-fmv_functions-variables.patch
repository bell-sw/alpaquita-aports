From ea10c03a2a8b94b4715266ab4fccdd4c5b746a27 Mon Sep 17 00:00:00 2001
From: Alexey Kodanev <aleksei.kodanev@bell-sw.com>
Date: Fri, 16 Jun 2023 14:12:34 +0000
Subject: [PATCH] support fmv_targets and fmv_functions variables

'fmv_src_prefix' is used for custom build paths.
---
 abuild.in | 27 +++++++++++++++++++++++++++
 1 file changed, 27 insertions(+)

diff --git a/abuild.in b/abuild.in
index 29daaa8..b0ff164 100644
--- a/abuild.in
+++ b/abuild.in
@@ -788,6 +788,11 @@ default_prepare() {
 				;;
 		esac
 	done
+
+	if [ "$fmv_targets" ] && [ "$fmv_functions" ]; then
+		setup_fmv
+	fi
+
 	if [ -z "$failed" ]; then
 		return 0
 	fi
@@ -3134,6 +3139,28 @@ remove_cflags()
 	export CPPFLAGS="${CPPFLAGS/$f/}"
 }
 
+setup_fmv()
+{
+	[ "$CARCH" = "x86_64" ] || return
+
+	local i targets functions
+	local cflags="-fopt-info -fplugin=fmv"
+
+	for i in $fmv_targets; do
+		[ "$targets" ] && targets="$targets,$i" || targets="-fplugin-arg-fmv-targets=$i"
+	done
+	for i in $fmv_functions; do
+		[ -f "$builddir/${i%%:*}" ] || die "fmv: missing src file $builddir/${i%%:*}"
+
+		local fn="${fmv_src_prefix}$i"
+		[ "$functions" ] && functions="$functions,$fn" || \
+		                    functions="-fplugin-arg-fmv-functions=$fn"
+	done
+
+	cflags="$cflags $targets $functions"
+	export CFLAGS="$CFLAGS $cflags"
+}
+
 if options_has "!annobin" || [ -n "$ABUILD_DISABLE_ANNOBIN" ] ; then
 	remove_cflags "-fplugin=annobin"
 fi
-- 
2.41.0

