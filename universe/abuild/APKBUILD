pkgname=abuild
pkgver=3.9.0
_ver=${pkgver%_git*}
pkgrel=19
pkgdesc="Script to build Alpaquita Packages (Alpine compatible)"
url="https://git.alpinelinux.org/cgit/abuild/"
arch="all"
license="GPL-2.0-only"
depends="
	fakeroot
	scanelf
	openssl
	apk-tools
	libc-utils
	attr
	tar
	pkgconf
	patch
	lzip
	annobin
	"

if [ "$CBUILD" = "$CHOST" ]; then
	depends="$depends curl"
fi
makedepends_build="pkgconfig scdoc"
makedepends_host="openssl1.1-compat-dev zlib-dev"
makedepends="$makedepends_host $makedepends_build"
checkdepends="bats"
install="$pkgname.pre-install $pkgname.pre-upgrade"
subpackages="
	apkbuild-cpan:cpan:noarch
	apkbuild-gem-resolver:gems:noarch
	apkbuild-pypi:pypi:noarch
	abuild-rootbld:_rootbld:noarch
	$pkgname-doc
	"
options="suid"
pkggroups="abuild"
source="https://gitlab.alpinelinux.org/alpine/abuild/-/archive/$pkgver/abuild-$pkgver.tar.gz
	0001-Add-BellSoft-Alpaquita-Linux-naming-customizations.patch
	0002-add-sign_kernel_modules-helper.patch
	0003-Added-support-for-glibc-toolchains.patch
	0004-handle-libc-tags-in-depends-makedepends.patch
	0005-support-getting-maintainer-name-from-env-variable.patch
	0006-new-alternative-variable.patch
	0007-fix-busybox-path.patch
	0008-Don-t-add-bin-sh-dependency-for-glibc-bin.trigger.patch
	0009-fix-reproducibility-test-and-skip-locking-test.patch
	0010-add-common-gcc-optimization-flags-for-builds.patch
	0011-abuild.conf-enable-stack-protector-strong-and-_FORTI.patch
	0012-abuild-warn-if-bin-sbin-or-lib-is-found.patch
	0013-create-common-vendor-variables.patch
	0014-add-a-new-step-to-sign-files-with-sign_impl-command.patch
	"
builddir="$srcdir"/abuild-$pkgver

prepare() {
	default_prepare

	sed -i -e "/^CHOST=/s/=.*/=$CHOST/" abuild.conf
}

build() {
	make VERSION="$pkgver-r$pkgrel"
}

check() {
	make check
}

package() {
	make install VERSION="$pkgver-r$pkgrel" DESTDIR="$pkgdir"

	install -m 644 abuild.conf "$pkgdir"/etc/abuild.conf
	install -d -m 775 -g abuild "$pkgdir"/var/cache/distfiles
}

cpan() {
	pkgdesc="Script to generate perl APKBUILD from CPAN"
	depends="perl perl-libwww perl-json perl-module-build perl-module-build-tiny
		perl-lwp-protocol-https"

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/apkbuild-cpan "$subpkgdir"/usr/bin/
}

gems() {
	pkgdesc="APKBUILD dependency resolver for RubyGems"
	depends="ruby ruby-augeas"

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/apkbuild-gem-resolver "$subpkgdir"/usr/bin/
}

pypi() {
	pkgdesc="Script to generate python3 APKBUILD from PYPI"
	depends="perl perl-libwww perl-json perl-module-build-tiny perl-lwp-protocol-https
	perl-ipc-system-simple"

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/apkbuild-pypi "$subpkgdir"/usr/bin/
}

_rootbld() {
	pkgdesc="Build packages in chroot"
	depends="abuild bubblewrap gettext git"
	mkdir -p "$subpkgdir"
}

sha512sums="
a3075b18d4a085ca796d1c2df703c3e7c80e682623175eb0822479f3a6d96ffba571f283bdec8ae3db832e296f9e58bdd0f58097b86b503a91fbb40148084a68  abuild-3.9.0.tar.gz
fd015eb8aa847d502bba63c719707a5f1f0929a231a6dd236cced8c8df2a0e4cc104bf6d45dee9e61eaad8873afde36b89b465d1d749ac2ae1902f97afbeda24  0001-Add-BellSoft-Alpaquita-Linux-naming-customizations.patch
466a329547c06583302b51d1849fa447216eb8bf09fc46971edb8d8153574b46a322b4cd056c35ac6883800c9c3df3313318e07d907e492eb22a8949070f2546  0002-add-sign_kernel_modules-helper.patch
a7ec47f7661c0f156e72516ef3edeb3e8971f00acef84a90ac40d3bf3a23a5c148a5edfa99cf77341f4cc5f79d95fd4503555aae4fa1bc3cf4a6409ceaddfcdc  0003-Added-support-for-glibc-toolchains.patch
1593d0f31d6ff8d10ad3776a68939d95c59cbc8ab8ac6609fda626e48a4fe1bac980688ef677927966494eb28dc6a3bdddbfb4be8fca4e2e3719716e83e3f6b1  0004-handle-libc-tags-in-depends-makedepends.patch
cd4842d905cc82028bd1e9e303ac7c955733ca5dde6dc07e1dd5d2cc1b6fd9654054fdd3a29ed4a6047a2a18002e15c81ae2986b41592a0ea3a1575a0387bb92  0005-support-getting-maintainer-name-from-env-variable.patch
c96fcacff59bd38cb336f0ce5c749fac0ee0dfc02c1df8fa8a6deb976165884285aca85ed83fb1e1c3bf56db844439eb5b986d38654859dd7d95c91255e694fd  0006-new-alternative-variable.patch
a6eb4fbfeeecf19df4def5495f4d6c11b95b3cc1e7f6fb1ea8068532816f2e9653b302043f24fab3d15c5cd7a98f95a6597e94a4c234b101c39a567d91aa9937  0007-fix-busybox-path.patch
543a22b3ee691e3507ed624b14cc9580e4f0cf093cb9670e81722f4c16f7faba8e05d9ac638001dc6ba9389d2203902b888fc4f9f6545b998b076543d5d29ca4  0008-Don-t-add-bin-sh-dependency-for-glibc-bin.trigger.patch
f34860ef388f1f15268e4d75f95044e127caa7a73600422303848f575ce81cfb8fb3855dcc280665fa4607761d317ea833107b4eaf5663c52aa86b0d9df3c3ce  0009-fix-reproducibility-test-and-skip-locking-test.patch
776b6b7c66ee0ab56bcecf57032e32a2d6a9ef3ec7f1997c91f5ee771b82d78104e376a07778a5ccb0aa002870a314597694a656b90a13dc4c233cf816892aae  0010-add-common-gcc-optimization-flags-for-builds.patch
83ee6d42a6c7dc73322c0782e849a8d26214544a7503d4dd7b2757a757dcdc9d1ba64864400cdd118454f910624a441328b9aa27e72d1ee8aae9a48894386a52  0011-abuild.conf-enable-stack-protector-strong-and-_FORTI.patch
9b91f1a756509434ee81747fe64c0717d35711e29db7c4675fd06578ab005744faf7ef0f846a1e9a8f04a7d3336da2c4697263e4a4adad3c95431a115baedc6f  0012-abuild-warn-if-bin-sbin-or-lib-is-found.patch
c88f31e0d539d1ccb7e009c3fba8dd1ca3f7a1bc1dbe2a23306fc0afaf72d96a7936dbd3194d1875ea32e9c249388cae4aaf6bd36af5e1f6a55d4cb70bf0d36b  0013-create-common-vendor-variables.patch
af347418d0a5f8d6f87e1bac3c795062b36067acea3bd556e6012740f56e90e62960750a7165e126d95abe6d68e8ef756f7c6277a866c3fd5096c06c86322291  0014-add-a-new-step-to-sign-files-with-sign_impl-command.patch
"
