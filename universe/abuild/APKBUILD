pkgname=abuild
pkgver=3.11.17
_ver=${pkgver%_git*}
pkgrel=0
pkgdesc="Script to build packages (Alpine compatible)"
url="https://git.alpinelinux.org/cgit/abuild/"
arch="all"
license="GPL-2.0-only"
depends="
	apk-tools>=2.0.7-r1
	attr
	cmd:getcap
	fakeroot
	libc-utils
	lzip
	openssl>3
	patch
	pkgconf
	scanelf
	tar
	annobin
	"
if [ "$CBUILD" = "$CHOST" ]; then
	depends="$depends curl"
fi
makedepends_build="pkgconfig scdoc"
makedepends_host="openssl-dev>3 zlib-dev"
makedepends="$makedepends_host $makedepends_build"
checkdepends="cmd:setcap kyua git"
install="$pkgname.pre-install $pkgname.pre-upgrade"
subpackages="
	apkbuild-cpan:cpan:noarch
	apkbuild-gem-resolver:gems:noarch
	apkbuild-pypi:pypi:noarch
	abuild-rootbld:_rootbld:noarch
	$pkgname-doc
	"
options="suid"
pkggroups="abuild"
source="https://gitlab.alpinelinux.org/alpine/abuild/-/archive/$pkgver/abuild-$pkgver.tar.gz
	0100-Add-distro-naming-customizations.patch
	0101-add-sign_kernel_modules-helper.patch
	0102-Added-support-for-glibc-toolchains.patch
	0103-handle-libc-tags-in-depends-makedepends.patch
	0104-support-getting-maintainer-name-from-env-variable.patch
	0105-new-alternative-variable.patch
	0106-fix-busybox-path.patch
	0107-Don-t-add-bin-sh-dependency-for-glibc-bin.trigger.patch
	0108-add-common-gcc-optimization-flags-for-builds.patch
	0109-abuild.conf-enable-stack-protector-strong-and-_FORTI.patch
	0110-abuild-warn-if-bin-sbin-or-lib-is-found.patch
	0111-create-common-vendor-variables.patch
	0112-add-a-new-step-to-sign-files-with-sign_impl-command.patch
	0113-skip-fetch-locking-test.patch
	0114-Add-distro-vendor-variables.patch
	0115-auto-provides-skip-debuginfo-files.patch
	0116-move-vendor-variables-to-functions.sh.in.patch
	0117-Add-repo-base-url-vendor-variable.patch
	0118-fix-arch-triplets.patch
	0119-support-fmv_targets-and-fmv_functions-variables.patch
	"
builddir="$srcdir"/abuild-$pkgver

build() {
	make VERSION="$pkgver-r$pkgrel"
}

check() {
	make check
}

package() {
	make install VERSION="$pkgver-r$pkgrel" DESTDIR="$pkgdir"

	install -m 644 abuild.conf "$pkgdir"/etc/abuild.conf

	case "$CARCH" in
	x86*|ppc64le)
		# binutils only supports it here
		cat >>"$pkgdir"/usr/share/abuild/default.conf <<-EOF

		# binutils ld.bfd supports this on this architecture; default to it
		export RUSTFLAGS="\$RUSTFLAGS -Clink-arg=-Wl,-z,pack-relative-relocs"
		export LDFLAGS="\$LDFLAGS -Wl,-z,pack-relative-relocs"
		EOF
	esac

	case "$CARCH" in
	x86_64)
		# https://lists.alpinelinux.org/~alpine/devel/%3C1628515011.zujvcn248v.none%40localhost%3E
		# note that this is x86-exclusive. on other architectures, this is pretty much always bad
		# https://github.com/rust-lang/rust/pull/106380
		cat >>"$pkgdir"/usr/share/abuild/default.conf <<-EOF

		# -fno-plt has very slight improvements to general code size and speed on x86-only,
		# for the common system dynamic linking case
		export CFLAGS="\$CFLAGS -fno-plt"
		export CXXFLAGS="\$CXXFLAGS -fno-plt"
		EOF
		;;
	esac

	install -d -m 775 -g abuild "$pkgdir"/var/cache/distfiles
}

cpan() {
	pkgdesc="Script to generate perl APKBUILD from CPAN"
	depends="perl perl-libwww perl-json perl-module-build perl-module-build-tiny
		perl-lwp-protocol-https"

	amove usr/bin/apkbuild-cpan
}

gems() {
	pkgdesc="APKBUILD dependency resolver for RubyGems"
	depends="ruby ruby-augeas"

	amove usr/bin/apkbuild-gem-resolver
}

pypi() {
	pkgdesc="Script to generate python3 APKBUILD from PYPI"
	depends="perl perl-libwww perl-json perl-module-build-tiny perl-lwp-protocol-https
	perl-ipc-system-simple"

	amove usr/bin/apkbuild-pypi
}

_rootbld() {
	pkgdesc="Build packages in chroot"
	depends="abuild bubblewrap cmd:envsubst git"
	mkdir -p "$subpkgdir"
}

sha512sums="
20335a11ab055b837a497dbc6cb8d19e40d15374c94166f4aac1e84a69792edda3d2d9d14a1fb72901f57ec75da386c2c2cb490866375c80c787621767974d46  abuild-3.11.17.tar.gz
dc27abdef11eb27771518fd03e9d814fd0eac273587e542f174e1fd8a68fba303fd9958c9cf02dc8994c0b298b40a1f412a017960d5a3a41f80a5db14fd4fb15  0100-Add-distro-naming-customizations.patch
b0c592a1b7e60ba9f1ac129147357d31d91dfca72a7ad0417926b3a60828febc1ef8f6f891c29a362d406cf1325d07572b9318acdeff37552f72facb2e86dc1c  0101-add-sign_kernel_modules-helper.patch
92a5a281a048b3848a3a1247048df2a03a1f27193ae2e6bec300a75deabd0cede5eb8e7862aa180083be08cbe377a79d1723f5330410a7af5ff3359597ef8c75  0102-Added-support-for-glibc-toolchains.patch
2a0a181e378a6c22e64bb42ad102c022b779e2f5c35ee7d93e0ce8fd2a0ab057ebc36913aae7e5198888bad1cba2729a95da5292a0c384cf267be2c0339dbbd1  0103-handle-libc-tags-in-depends-makedepends.patch
c2d01d82e3ab15ddd141d3ec48d06433dbb41d45f6394ab0babd55ab15f94a91954ffc33110c006c439c80ecb6998d08abea51fa48a111270b8942b8896b3256  0104-support-getting-maintainer-name-from-env-variable.patch
33f487d1bf26c9dbc0badda133cde7ed4bc75dc747d9e9724d587f393257527ee90d40d5f0085f063b41ccc1d992b13c846f01b93bbbd98e64c83097b2f8500f  0105-new-alternative-variable.patch
27c78caf3d55ccc1f78c19a96d4afd05f8bb3b4d021d2b62031948df9b9851ec27ec7690028af341431ffb46d789d7ce3951492c475f51343d703c3dd215fdeb  0106-fix-busybox-path.patch
4777499652fa1f1ee610494e33cd279ece75fcc5aca1de6bb286ecfcb81031adee9537c6d1a31a69182665052b0a4d2422f1e0cb1bf3ef3595cae17b91ad044f  0107-Don-t-add-bin-sh-dependency-for-glibc-bin.trigger.patch
bc6addb2ac09d25d8c67df29c0f258c5a90791d01c3b6ad4bc08d1131d2b48b10b58b2f9a5169b829543bb1c73d9af5a845d403c7c721aa2e43ebfe5d199377e  0108-add-common-gcc-optimization-flags-for-builds.patch
1ff735ea9469956eff9b2dca52dc8a9ece14ce37db2e37f839b218d738903ae10b07726db70ad806d2c35612788ff351b4298ce9bfaf88570070ea5c3c468569  0109-abuild.conf-enable-stack-protector-strong-and-_FORTI.patch
4ea5d392cccdab9706ebf47374f3a63230a15150b6f5881649985affeeb5663acf9ad64632cbe04cf16374f61bf07ec42c125c22f96b1f1689c7ddf1cc6e3c13  0110-abuild-warn-if-bin-sbin-or-lib-is-found.patch
bf806a7f79530f531b1e7121555a8feaade32813569da89179cc574650861c8dfe167b914d2b2a398dd4d6ac6c90c194bc21d285f5f3cb256c334358a7dbf142  0111-create-common-vendor-variables.patch
41e0013e9337517b8c0814ffc2127f4e9a10d7729fe44797869febfd44560c4d542bd8c250d4e075fc562ca2b3c8c456d0284b39727ac6526739bab23248e4dc  0112-add-a-new-step-to-sign-files-with-sign_impl-command.patch
1e2b11a4968ec0b67ef0b0899d3546e62a221808aa32d62889720c5b94b58bb88fc9661df7553e0371bea07dd282f73b24c0d1e82d4e59ac1a92eb1499b8585a  0113-skip-fetch-locking-test.patch
5fb627c7e63442d5dac85d6c96d05899b5f4cecd49addc930b9fb155d3902c9facac1fb116b416a4bdcb82af2f8c375c3fd9a29ab8325183cb27f79a2221991a  0114-Add-distro-vendor-variables.patch
2bbfbae32ecd61f49dafd0d30c1e62d91e497509275ed7dcc87975d53a013eac5eb8f8462b27d9f5044e34f9e47dbc9a94438a53f268667834e225d037143231  0115-auto-provides-skip-debuginfo-files.patch
651efe589ac114cabffee79fe809aaa8072b59fac4985b21997120df2e8208cbfe6c1bc12efca30d95d7ba2fb76cf8c0be67e5feca56d746767cde0df0b51962  0116-move-vendor-variables-to-functions.sh.in.patch
311fa73a3207dbce91fa4b9f4607d90429162f2418f3ea5e50f2e562e42b0d75800471c4fe22d7459dc408ff6ed39f8cbfb8645fde1723927a75e0a6c43de6ef  0117-Add-repo-base-url-vendor-variable.patch
c5987f1e145beb8587bcb5984aacc2f117a036c28b6de25b2c395eb02c4cb05bee7f75afe0ba9335d0f817c763a0d4c66a8a43ce5ca2dc1b6816145576627c49  0118-fix-arch-triplets.patch
6cbebd683d1c94f95c2dc588555b468d1ef199bcd1b3f21af0b587c9e6a31da8090e36b6c304581ed66e045a34f8154401e18e3c529085386fdef214365bcf0c  0119-support-fmv_targets-and-fmv_functions-variables.patch
"
