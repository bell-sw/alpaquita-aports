pkgname=abuild
pkgver=3.11.20
_ver=${pkgver%_git*}
pkgrel=2
pkgdesc="Script to build packages (Alpine compatible)"
url="https://git.alpinelinux.org/cgit/abuild/"
arch="all"
license="GPL-2.0-only"
depends="
	apk-tools>=2.0.7-r1
	attr
	cmd:getcap
	fakeroot
	libc-utils
	lzip
	openssl>3
	patch
	pkgconf
	scanelf
	tar
	annobin
	"
if [ "$CBUILD" = "$CHOST" ]; then
	depends="$depends curl"
fi
makedepends_build="pkgconfig scdoc"
makedepends_host="openssl-dev>3 zlib-dev"
makedepends="$makedepends_host $makedepends_build"
checkdepends="cmd:setcap kyua git"
install="$pkgname.pre-install $pkgname.pre-upgrade"
subpackages="
	apkbuild-cpan:cpan:noarch
	apkbuild-gem-resolver:gems:noarch
	apkbuild-pypi:pypi:noarch
	abuild-rootbld:_rootbld:noarch
	$pkgname-doc
	"
options="suid"
pkggroups="abuild"
source="https://gitlab.alpinelinux.org/alpine/abuild/-/archive/$pkgver/abuild-$pkgver.tar.gz
	0100-Add-distro-naming-customizations.patch
	0101-add-sign_kernel_modules-helper.patch
	0102-Added-support-for-glibc-toolchains.patch
	0103-handle-libc-tags-in-depends-makedepends.patch
	0104-support-getting-maintainer-name-from-env-variable.patch
	0105-new-alternative-variable.patch
	0106-fix-busybox-path.patch
	0107-Don-t-add-bin-sh-dependency-for-glibc-bin.trigger.patch
	0108-add-common-gcc-optimization-flags-for-builds.patch
	0109-abuild.conf-enable-stack-protector-strong-and-_FORTI.patch
	0110-abuild-warn-if-bin-sbin-or-lib-is-found.patch
	0111-create-common-vendor-variables.patch
	0112-add-a-new-step-to-sign-files-with-sign_impl-command.patch
	0113-skip-fetch-locking-test.patch
	0114-Add-distro-vendor-variables.patch
	0115-auto-provides-skip-debuginfo-files.patch
	0116-move-vendor-variables-to-functions.sh.in.patch
	0117-Add-repo-base-url-vendor-variable.patch
	0118-fix-arch-triplets.patch
	0119-support-fmv_targets-and-fmv_functions-variables.patch
	"
builddir="$srcdir"/abuild-$pkgver

build() {
	make VERSION="$pkgver-r$pkgrel"
}

check() {
	make check
}

package() {
	make install VERSION="$pkgver-r$pkgrel" DESTDIR="$pkgdir"

	install -m 644 abuild.conf "$pkgdir"/etc/abuild.conf

	case "$CARCH" in
	x86*|ppc64le)
		# binutils only supports it here
		cat >>"$pkgdir"/usr/share/abuild/default.conf <<-EOF

		# binutils ld.bfd supports this on this architecture; default to it
		export RUSTFLAGS="\$RUSTFLAGS -Clink-arg=-Wl,-z,pack-relative-relocs"
		export LDFLAGS="\$LDFLAGS -Wl,-z,pack-relative-relocs"
		EOF
	esac

	case "$CARCH" in
	x86_64)
		# https://lists.alpinelinux.org/~alpine/devel/%3C1628515011.zujvcn248v.none%40localhost%3E
		# note that this is x86-exclusive. on other architectures, this is pretty much always bad
		# https://github.com/rust-lang/rust/pull/106380
		cat >>"$pkgdir"/usr/share/abuild/default.conf <<-EOF

		# -fno-plt has very slight improvements to general code size and speed on x86-only,
		# for the common system dynamic linking case
		export CFLAGS="\$CFLAGS -fno-plt"
		export CXXFLAGS="\$CXXFLAGS -fno-plt"
		EOF
		;;
	esac

	install -d -m 775 -g abuild "$pkgdir"/var/cache/distfiles
}

cpan() {
	pkgdesc="Script to generate perl APKBUILD from CPAN"
	depends="perl perl-libwww perl-json perl-module-build perl-module-build-tiny
		perl-lwp-protocol-https"

	amove usr/bin/apkbuild-cpan
}

gems() {
	pkgdesc="APKBUILD dependency resolver for RubyGems"
	depends="ruby ruby-augeas"

	amove usr/bin/apkbuild-gem-resolver
}

pypi() {
	pkgdesc="Script to generate python3 APKBUILD from PYPI"
	depends="perl perl-libwww perl-json perl-module-build-tiny perl-lwp-protocol-https
	perl-ipc-system-simple"

	amove usr/bin/apkbuild-pypi
}

_rootbld() {
	pkgdesc="Build packages in chroot"
	depends="abuild bubblewrap cmd:envsubst git"
	mkdir -p "$subpkgdir"
}

sha512sums="
494045a023420e7d52cbacd3b5ada1510e1def89107004b88a4a9cb16b6455e7195592abef996fee57bfaf3e2b80d8422fc96b7da39e07f4cd3fb72becfaa6c7  abuild-3.11.20.tar.gz
fc7622f2a80cb5d777aea623bd3d13aa7df613dafa2cf273b5e4d65526baf6082ed355a21d6114210d4cef3633f0e606a97c23cccc7e3785b8229ff6b7962638  0100-Add-distro-naming-customizations.patch
cd1cced2036a4a738054cbe9b9cc390e3b053f96a59e433959a4568615f17cc20ad31b88d2ca5ac741e6163117fde594d29c4716cf01ef2a00c228e07c73e81d  0101-add-sign_kernel_modules-helper.patch
0611a0d8531bd2e9cb3b457c493ff2ef7cf2c023857327007e4251de145e9a1f5eed39d5acfeb6b1b73097181d7fae1fcf992f3d25a3697d4ec6eb5aa5f7590b  0102-Added-support-for-glibc-toolchains.patch
3722b2bdfd59fae9108c33552eac401b8cfa0c31bf05d8b036dd865ae9c7460c97d8ee00d859d609ecd80eefb539bea7f0687c5f0f461c3ef158f7bbce9a91fd  0103-handle-libc-tags-in-depends-makedepends.patch
0f5b8cc3d8db57353290b902cea3da7d1f233bbcdee187504891ce4135f68fae792e9e798729c79f60866dd0f4e9f7872fe7df9e2d6ad4b4bb75592ec79acd52  0104-support-getting-maintainer-name-from-env-variable.patch
639e1eef5a5e955c39e5de85abc35b9677e475203ac404c3f06e0c360747ae194e1b5ab0dd23eb62d7eb22c9f7ddb99538c54540bbd5f46ecb3bfd0558fdc556  0105-new-alternative-variable.patch
67fb621029f7bd69d8ae71d8640adab36d1e87cd13d290525765fa88316e23be3118c5eac9ad3c5bed088b6da1b223dbfe2ebb733975bb8e43748a3d9178f606  0106-fix-busybox-path.patch
d3b1bba00bbb834276349dbfe86b664c956348684273ecf78bc3bc562a1bca1d0576b07b2c81990a901e05980d79918a9d4d6c94fe7a54d0b1fdb31496ac448c  0107-Don-t-add-bin-sh-dependency-for-glibc-bin.trigger.patch
aeafcbbfe4479f16512e51bc8c1e72069207749d51ea3c5667141f56ed67debd6c55acde837200afc3a6b61c48e1abf22005cbac15b9ca4d459538a9dc1515c6  0108-add-common-gcc-optimization-flags-for-builds.patch
47256665d57066098335cf658f9f4410d34e5f091082ef35eae3fca72a17769c9204648da237a211d9fd6258e34dc33203f919368d4061b07d987100528937c8  0109-abuild.conf-enable-stack-protector-strong-and-_FORTI.patch
3fb10cf55a6cd0758eb42bdcff74a20bd56d4f5873cf8a3ff77c096635aa91e06ab3f7e81662e4aac2e0099489f774d7508efd2afbbeaef8ad3fd45a5d0f7bf6  0110-abuild-warn-if-bin-sbin-or-lib-is-found.patch
2fccfddd12636c9521d16961aaa5caa80775934a80447682f527b4353fcf1890550ea16117ac21a06d4144459266ac2d17c67627c48be30ffc11da1487ccc23d  0111-create-common-vendor-variables.patch
a0e20f939c4bc9a7cebb4fe6bd58682498a3a3a4a631062978cb3a410f17a5211fd41f6b6e65d464e4656fea2db0371bfe15d0515d864b821ca297a2d32ae55c  0112-add-a-new-step-to-sign-files-with-sign_impl-command.patch
06028e75c70c9a59cb694450232a94be98be3fa7fb7c6129a01004c5d075de5a58c4b69b1a0d5d2620ff57d2cfba9273b33dd7cb3831b7dd5777acbea7d37010  0113-skip-fetch-locking-test.patch
a91325fe6ed537b1cda6691437d1ec9d39a1a8a2fe3ab83fd8354e1bed074d395ca22906b972f90b0c5b1ea4a0c8c0cc6476a6a8a04034869388bb6a03491c4a  0114-Add-distro-vendor-variables.patch
83178e6c473751abad63d6a1268c3498671ddcf195b2f4862f74b03a5a9768268a1c120190f7da8d8b9d2a99b768420daf9e74ec42e89781c7bf80274c7f2c7c  0115-auto-provides-skip-debuginfo-files.patch
22ed13bda8b98017cf9d4dd7482e2ce66d00bc1e6b035c206dad9e28ab2fd9bddc81221d5506d2cddbd28671e7130b7ca199a52d056cf35cfdf19426d8853334  0116-move-vendor-variables-to-functions.sh.in.patch
d0fee05472493fef125652f67312d10b51ed6589b7f7e8ad1717de9cbe4aae0e0b9ce24b9c5301486d03153ac70a431b1a946f044098c69c4769d7385e183517  0117-Add-repo-base-url-vendor-variable.patch
58fd8002290614809237bd1750d269b793375782cb07042cd81707329895e602a1ec6a1997fa9c6febffebc5abb4ccd8b0339c4bb805ad7d6516ef9de40f20f7  0118-fix-arch-triplets.patch
4b7edb087e06c6660f04491d9ea85189a38479e12177a2a736e5cc37c2279f44993960c81b83f81caeaba142d6966a7facd25e8ac13e884e84c6d96702ccc09a  0119-support-fmv_targets-and-fmv_functions-variables.patch
"
