pkgname=abuild
pkgver=3.11.0_rc5
_ver=${pkgver%_git*}
pkgrel=0
pkgdesc="Script to build packages (Alpine compatible)"
url="https://git.alpinelinux.org/cgit/abuild/"
arch="all"
license="GPL-2.0-only"
depends="fakeroot scanelf openssl>3 apk-tools>=2.0.7-r1 libc-utils
	attr tar pkgconf patch lzip annobin"
if [ "$CBUILD" = "$CHOST" ]; then
	depends="$depends curl"
fi
makedepends_build="pkgconfig scdoc"
makedepends_host="openssl-dev>3 zlib-dev"
makedepends="$makedepends_host $makedepends_build"
checkdepends="kyua git"
install="$pkgname.pre-install $pkgname.pre-upgrade"
subpackages="
	apkbuild-cpan:cpan:noarch
	apkbuild-gem-resolver:gems:noarch
	apkbuild-pypi:pypi:noarch
	abuild-rootbld:_rootbld:noarch
	$pkgname-doc
	"
options="!check suid" # FIXME
pkggroups="abuild"
source="https://gitlab.alpinelinux.org/alpine/abuild/-/archive/$pkgver/abuild-$pkgver.tar.gz
	0100-Add-distro-naming-customizations.patch
	0101-add-sign_kernel_modules-helper.patch
	0102-Added-support-for-glibc-toolchains.patch
	0103-handle-libc-tags-in-depends-makedepends.patch
	0104-support-getting-maintainer-name-from-env-variable.patch
	0105-new-alternative-variable.patch
	0106-fix-busybox-path.patch
	0107-Don-t-add-bin-sh-dependency-for-glibc-bin.trigger.patch
	0108-add-common-gcc-optimization-flags-for-builds.patch
	0109-abuild.conf-enable-stack-protector-strong-and-_FORTI.patch
	0110-abuild-warn-if-bin-sbin-or-lib-is-found.patch
	0111-create-common-vendor-variables.patch
	0112-add-a-new-step-to-sign-files-with-sign_impl-command.patch
	0113-skip-fetch-locking-test.patch
	0114-Add-distro-vendor-variables.patch
	0115-auto-provides-skip-debuginfo-files.patch
	0116-move-vendor-variables-to-functions.sh.in.patch
	0117-Add-repo-base-url-vendor-variable.patch
	0118-fix-arch-triplets.patch
	0119-support-fmv_targets-and-fmv_functions-variables.patch
	"
builddir="$srcdir"/abuild-$pkgver

prepare() {
	default_prepare

	sed -i -e "/^CHOST=/s/=.*/=$CHOST/" abuild.conf
}

build() {
	make VERSION="$pkgver-r$pkgrel"
}

check() {
	make check
}

package() {
	make install VERSION="$pkgver-r$pkgrel" DESTDIR="$pkgdir"

	install -m 644 abuild.conf "$pkgdir"/etc/abuild.conf

	case "$CARCH" in
	x86*|ppc64le)
		# binutils only supports it here
		cat >>"$pkgdir"/etc/abuild.conf <<-EOF

		export RUSTFLAGS="-Clink-arg=-Wl,-z,pack-relative-relocs"
		export LDFLAGS="\$LDFLAGS -Wl,-z,pack-relative-relocs"
		EOF
	esac

	install -d -m 775 -g abuild "$pkgdir"/var/cache/distfiles
}

cpan() {
	pkgdesc="Script to generate perl APKBUILD from CPAN"
	depends="perl perl-libwww perl-json perl-module-build perl-module-build-tiny
		perl-lwp-protocol-https"

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/apkbuild-cpan "$subpkgdir"/usr/bin/
}

gems() {
	pkgdesc="APKBUILD dependency resolver for RubyGems"
	depends="ruby ruby-augeas"

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/apkbuild-gem-resolver "$subpkgdir"/usr/bin/
}

pypi() {
	pkgdesc="Script to generate python3 APKBUILD from PYPI"
	depends="perl perl-libwww perl-json perl-module-build-tiny perl-lwp-protocol-https
	perl-ipc-system-simple"

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/apkbuild-pypi "$subpkgdir"/usr/bin/
}

_rootbld() {
	pkgdesc="Build packages in chroot"
	depends="abuild bubblewrap cmd:envsubst git"
	mkdir -p "$subpkgdir"
}

sha512sums="
db7510f06548307e5d173ad04984a7eee54d2c9503a442af0c0ed26b6c70e2748e171bb3576621c6581e00c2b96fe09b96ad8ba2920a4a398da50c1fa38dceb6  abuild-3.11.0_rc5.tar.gz
d50e7567653d7c7821c7ef44be0bc186976a8652c9b55625a212e054484a96ba0143188bb319850db20adcbf959d1344d312fa96907da325653dcb79773923e6  0100-Add-distro-naming-customizations.patch
4e83b3da20595cda45064f9d2a5661992737668467181d04cf7cf4e4aff70022669caa1bdacd3a864866d4cf2cf12f6f3511a5208bc49745026fdc1024775e69  0101-add-sign_kernel_modules-helper.patch
4f4708837ccdf998f075b108524ff63d5c372ede392d1758d68a0cdd28d6f7df99eaed624579a08699eaba8234510d6dd56b810b8df144d26af6f74de00c1daa  0102-Added-support-for-glibc-toolchains.patch
260cae68327bacff90d05a0e9236148859e7cd33dd37c5434d3fd6e78ebfa198ef2c2e8b012f86d393f146bf1e137e0ba7691466f3732454ee2c8cee30c814b8  0103-handle-libc-tags-in-depends-makedepends.patch
451695a60d620103e39c0e501ec2f4a1976e0348cce31f9cc67f2298b69b49c157386e7329a8d9999961b68996dbb56785fafa063c9c2daa7acde48f2553d97c  0104-support-getting-maintainer-name-from-env-variable.patch
129f47003a21c0f2b368a68d011e8e86c48dbc1a15136ee0aad92c862837dc0fe948bad20bcd94955039a2918fbc5de1c6a58ba68678ee72e6b7cfaf2e871ac6  0105-new-alternative-variable.patch
c22e173ab015c0826e58737fc081162c55535e5c24ffb24537e528af0a69a36262cd567f71bcffd3770b6016059240feb0bece3589f16e8992725bbcbd7797d9  0106-fix-busybox-path.patch
020edd1633df0581d5fcf3c18296732d1e4d50f80f504ea63c6129b0340b3ed0d274c7f9d0da4c331435789bcdfd0b59de5631062e8eeb7f40a92085cf09847d  0107-Don-t-add-bin-sh-dependency-for-glibc-bin.trigger.patch
558897e2c4cef933a0f783cdd316e8cfebaca5fc86811556f8232d2399f0c0390ccb26abf9f7e318b815b534433fd63840d1078e45ac3d14fd49770a0025a762  0108-add-common-gcc-optimization-flags-for-builds.patch
24949b3ad7c5a933e85d08b9b0849fa032f62ae427a6a5faa4b07842a7c94fb3c2c225e9e0d373c3314a42d17cf6ef06c28f02faaa4fece0fec6034386dc4f5a  0109-abuild.conf-enable-stack-protector-strong-and-_FORTI.patch
d73fd0065ca2714116e8c031663c09cae4be98eb60dc3b777dbc23180bb59bac126a610e381ee7434d21757c942e3ec78da8b4240d94ebff6876d256f11907d3  0110-abuild-warn-if-bin-sbin-or-lib-is-found.patch
dacdb9e23991c0caf3f121da2acebdd0dcd8d201d161452cdf3bc0a35b1f17d74f8d7f9c2556e226a30684ddf172ce6adf34d674c08b9a9b707e97309f1c7d32  0111-create-common-vendor-variables.patch
4392223a8689bccc0f00f4f9485886986ccfd3ab3f3d6dda95c34fd84f039fe4c38200b5989b170f3f441e321a87c3d0eb130091b020e3f20cf3b980a4ffd34e  0112-add-a-new-step-to-sign-files-with-sign_impl-command.patch
a2e1dcfeea6f9f595cad5551d664e0c901e418b9582cefc8bba6d2b4a9eae02b4fad886a4be4554c039245f3ab54e2fefbd026a623a3062b4e27eb8a29332feb  0113-skip-fetch-locking-test.patch
df5a0684ef3601e0783ac26cadb167a2ebfe6585993db174b3b6d589e7df97cef8888c15bfe0c6765e82828810f40f30524bd145e4a23a71d7803d18345fe4b1  0114-Add-distro-vendor-variables.patch
b926e419028a94272ebb2c08466f90b48f2fa99172c8bfbd3df7a07b76b6adb4858f4349b37310bfd9b23caee4ed2446b1b72b1a90b7b4f6cbe3ff43e1053a63  0115-auto-provides-skip-debuginfo-files.patch
c87b451f5ed4d6271630c18aa52dec2f4cfd05065ee5ec10cb77e2f073988dcf20074cef28a8ffe6f9751a0fcac31fb9b9c95adb518b2a78d40ed14b5d420e0d  0116-move-vendor-variables-to-functions.sh.in.patch
c5427b1c730481e174f5980ae4a38403c61eb5575386f6f5fc71657674f942e39f1b878ff80e32a90e443e5d6b612b2f2efc8223dff1e7863752de7f1b506a05  0117-Add-repo-base-url-vendor-variable.patch
80464fce41340cfe5a8c5d63fb179c6c759f17f40bc7699d52bce58bc42bb4a265deecc0d861800228d59cc42183a9a94f345153a66df3a592184bed9f840e01  0118-fix-arch-triplets.patch
387a67a20d97896dc1f85cd5b6ae7cc013394c58527f24a35db018f35fa0d53d52b5a2e0fed0907f83a87a43589f4fd25042b06dfc833b03fe30ba8000e4dd99  0119-support-fmv_targets-and-fmv_functions-variables.patch
"
