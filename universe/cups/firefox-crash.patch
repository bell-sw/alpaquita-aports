Patch-Source: https://github.com/OpenPrinting/cups/pull/720
--
From d1ae16134f6fa9f53513a59fad1d10545174829c Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Emilio=20Cobos=20=C3=81lvarez?= <emilio@crisal.io>
Date: Mon, 5 Jun 2023 19:17:43 +0200
Subject: [PATCH] cups/dest.c: Don't call cupsEnumDests with no dest name to
 find default printer.

Fixes #719
---
 cups/dest.c | 64 ++++++++++++++++++++++++++---------------------------
 1 file changed, 32 insertions(+), 32 deletions(-)

diff --git a/cups/dest.c b/cups/dest.c
index 741aae0631..ed21d5c899 100644
--- a/cups/dest.c
+++ b/cups/dest.c
@@ -1836,49 +1836,49 @@ cupsGetNamedDest(http_t     *http,	/* I - Connection to server or @code CUPS_HTT
 
   if (!_cupsGetDests(http, op, dest_name, &dest, 0, 0))
   {
-      _cups_namedata_t  data;           /* Callback data */
-
+    _cups_namedata_t  data;           /* Callback data */
+    data.name = dest_name;
+    data.dest = NULL;
+    if (dest_name)
+    {
       DEBUG_puts("1cupsGetNamedDest: No queue found for printer, looking on network...");
-
-      data.name = dest_name;
-      data.dest = NULL;
-
       cupsEnumDests(0, 1000, NULL, 0, 0, (cups_dest_cb_t)cups_name_cb, &data);
+    }
 
-      if (!data.dest)
+    if (!data.dest)
+    {
+      switch (set_as_default)
       {
-	switch (set_as_default)
-	{
-	  default :
-	      _cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("The printer or class does not exist."), 1);
-	      break;
+        default :
+      _cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("The printer or class does not exist."), 1);
+      break;
 
-	  case 1 : /* Set from env vars */
-	      if (getenv("LPDEST"))
-		_cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("LPDEST environment variable names default destination that does not exist."), 1);
-	      else if (getenv("PRINTER"))
-		_cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("PRINTER environment variable names default destination that does not exist."), 1);
-	      else
-		_cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("No default destination."), 1);
-	      break;
+        case 1 : /* Set from env vars */
+      if (getenv("LPDEST"))
+        _cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("LPDEST environment variable names default destination that does not exist."), 1);
+      else if (getenv("PRINTER"))
+        _cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("PRINTER environment variable names default destination that does not exist."), 1);
+      else
+        _cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("No default destination."), 1);
+      break;
 
-	  case 2 : /* Set from ~/.cups/lpoptions */
-	      _cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("~/.cups/lpoptions file names default destination that does not exist."), 1);
-	      break;
+        case 2 : /* Set from ~/.cups/lpoptions */
+      _cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("~/.cups/lpoptions file names default destination that does not exist."), 1);
+      break;
 
-	  case 3 : /* Set from /etc/cups/lpoptions */
-	      _cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("/etc/cups/lpoptions file names default destination that does not exist."), 1);
-	      break;
+        case 3 : /* Set from /etc/cups/lpoptions */
+      _cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("/etc/cups/lpoptions file names default destination that does not exist."), 1);
+      break;
 
-	  case 4 : /* Set from server */
-	      _cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("No default destination."), 1);
-	      break;
-	}
+        case 4 : /* Set from server */
+      _cupsSetError(IPP_STATUS_ERROR_NOT_FOUND, _("No default destination."), 1);
+      break;
+      }
 
       return (NULL);
-      }
+    }
 
-      dest = data.dest;
+    dest = data.dest;
   }
 
   DEBUG_printf(("1cupsGetNamedDest: Got dest=%p", (void *)dest));
