pkgname=cmocka
pkgver=1.1.7
pkgrel=0
pkgdesc="An elegant unit testing framework for C with support for mock objects"
url="https://cmocka.org/"
arch="all"
license="Apache-2.0"
makedepends="cmake samurai"
subpackages="$pkgname-dev"
source="https://cmocka.org/files/${pkgver%.*}/cmocka-$pkgver.tar.xz
	musl:wordsize.patch"

build() {
	cmake -B build -G Ninja \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_LIBDIR=lib \
		-DBUILD_SHARED_LIBS=True \
		-DCMAKE_BUILD_TYPE=MinSizeRel \
		-DUNIT_TESTING=ON
	cmake --build build
}

check() {
	cd "$builddir"/build

	# If some tests fail, run them again in verbose mode.
	ninja test || ctest --rerun-failed --extra-verbose
}

package() {
	DESTDIR="$pkgdir" cmake --install build
}

sha512sums="
fe451893474dce1270e12af707a9a8fe1f0217e1782b4e1a67d25dadf56ff4a5e7dbc9ba4431f774aedffa46a40a28a6a0488df24feefb2f93e90fd2369c2c88  cmocka-1.1.7.tar.xz
6ceade1de2690242bfcc161a7c0d4ad807e630c6a8eaae93f27d3ae90821a266d77dcf8604e951caa5bc4b9f0f5c75c9a70bfb5b715659ba0d3426dfa1b88c5b  wordsize.patch
"
