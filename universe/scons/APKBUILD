pkgname=scons
pkgver=4.5.0
pkgrel=0
pkgdesc="Software construction system"
url="https://scons.org/"
arch="noarch"
license="MIT"
depends="python3"
makedepends="py3-setuptools"
checkdepends="xz"
subpackages="$pkgname-doc"
# fetching both sources, because only github tarball has tests
# and only sourceforge tarball has prebuilt manpages
# building the scons manpages requires working scons install...
source="https://github.com/SCons/scons/archive/$pkgver/scons-$pkgver.tar.gz
	https://downloads.sourceforge.net/project/scons/scons/$pkgver/SCons-$pkgver.tar.gz
	dont-install-manpages.patch
	"

# tests need py3-psutil from community
options="!check"

prepare() {
	default_prepare

	# remove failing test
	case $CARCH in
	ppc64le) rm test/builderrors.py ;;
	esac
}

build() {
	python3 setup.py build
}

check() {
	python3 runtest.py -a
}

package() {
	python3 setup.py install --skip-build --root="$pkgdir"

	# find and remove directories containing docbook files
	find "$pkgdir" -name 'docbook' -type d -exec rm -rf {} +

	install -Dm644 \
		"$srcdir"/SCons-$pkgver/scons.1 \
		"$srcdir"/SCons-$pkgver/scons-time.1 \
		"$srcdir"/SCons-$pkgver/sconsign.1 \
		-t "$pkgdir"/usr/share/man/man1/
}

sha512sums="
c471a9f68f9f48832836f24d5cba3f1c3493cb9bd85e01467ab1c509baf961259e87e1210b2218933e5c71bf85274246b5e98301fc85ea908ff4a10278c9a363  scons-4.5.0.tar.gz
df6b05cd8dbcca1e839b96bcfeb8d7aa34094e6b0c54d2fcbd2475d021223645d980073bc22bc26c4d83aa69f5c2ae24adfad4ee7529122ec2fe984be1a13ca6  SCons-4.5.0.tar.gz
286dbd5230119237b2ef2ece572d70c8b22d78ac71c5ac7a7a23e1c8597ca6379f324293560276777b608eb7b7af070374e8df91b593e6c656d81e13367efccd  dont-install-manpages.patch
"
