# Description:

pkgname=py3-setuptools
pkgver=67.6.1
pkgrel=1
pkgdesc="Collection of enhancements to the Python3 distutils"
options="!check" # Tests require packages out of main/
url="https://pypi.org/project/setuptools"
arch="noarch"
license="MIT"
# everything is vendored
depends="
	py3-packaging
	python3
	"
# depends="
# 	py3-appdirs
# 	py3-more-itertools
# 	py3-ordered-set
# 	py3-packaging
# 	python3
# 	"
subpackages="$pkgname-pyc"
source="$pkgname-$pkgver-2.tar.gz::https://pypi.io/packages/source/s/setuptools/setuptools-$pkgver.tar.gz"
builddir="$srcdir"/setuptools-$pkgver

provides="py-setuptools=$pkgver-r$pkgrel" # Backwards compatibility
replaces="py-setuptools" # Backwards compatiblity

# py3-setuptools needs itself to build, bootstrapped with a lower version
# in main/py3-setuptools-stage0
if [ -z "$BOOTSTRAP" ]; then
	# During bootstrapping py3-setuptools-bootstrap is provided by py3-setuptools-stage0
	provides="$provides py3-setuptools-bootstrap"
	provider_priority=100 # highest
fi

export SETUPTOOLS_INSTALL_WINDOWS_SPECIFIC_FILES=0

prepare() {
	default_prepare

	# Unbundle
	# rm -rf pkg_resources/extern pkg_resources/_vendor \
	# 	setuptools/extern setuptools/_vendor

	# Upstream devendoring logic is badly broken, see:
	# https://bugs.archlinux.org/task/58670
	# https://github.com/pypa/pip/issues/5429
	# https://github.com/pypa/setuptools/issues/1383
	# The simplest fix is to simply rewrite import paths to use the canonical
	# location in the first place
	# for _module in setuptools pkg_resources '' ; do
	# 	find . -name \*.py -exec sed -i \
	# 		-e 's/from '$_module.extern' import/import/' \
	# 		-e 's/from '$_module.extern'./from /' \
	# 		-e 's/import '$_module.extern'./import /' \
	# 		-e "s/__import__('$_module.extern./__import__('/" \
	# 		{} +
	# done

	# Fix post-release tag
	sed -e '/tag_build = .post/d' \
		-e '/tag_date = 1/d' \
		-i setup.cfg
}

build() {
	python3 setup.py build
}

package() {
	local _pyver=$(python3 -c 'import sys; print("{}.{}".format(sys.version_info.major, sys.version_info.minor))')
	# Otherwise it complains that build/scripts-3.10 cannot be found
	# no other changes noted
	mkdir -p "build/scripts-$_pyver"

	python3 setup.py install --root="$pkgdir" --skip-build
}

sha512sums="
197910ad4c4058af0107e240d2e27bc2c1ff373cb3fba33af09eb3cc42614c45e4bb73a65802f253466eafd94517e08b51e98f50213817ad03d88ee0ccf9adbc  py3-setuptools-67.6.1-2.tar.gz
"
