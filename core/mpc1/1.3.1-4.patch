From 8cd19d81f3e2aebbd58d8204da8ada50e8e8dfc1 Mon Sep 17 00:00:00 2001
From: Andreas Enge <andreas.enge@inria.fr>
Date: Mon, 12 Dec 2022 11:23:40 +0100
Subject: [PATCH] Do not explicitly include stdio.h in mpc-impl.h.

Several files include it on their own for MPC_ASSERT.

* src/mpc-impl.h, src/radius.c: Do not include stdio.h.
* tests/teta.c: Include mpc-tests.h instead of mpc-impl.h.
* src/balls.c (mpcb_out_str, mpcr_out_str): Define only when
  _GMP_H_HAVE_FILE is defined, in accordance with mpc.h.
* NEWS: Add entry for bug fix.
---
 NEWS           | 4 ++++
 src/balls.c    | 2 ++
 src/mpc-impl.h | 3 ---
 src/radius.c   | 4 +++-
 tests/teta.c   | 2 +-
 5 files changed, 10 insertions(+), 5 deletions(-)

diff --git a/NEWS b/NEWS
index ef6ff8b..c113262 100644
--- a/NEWS
+++ b/NEWS
@@ -1,3 +1,7 @@
+Changes in version 1.3.1, released in December 2022:
+  - Bug fix: It is again possible to include mpc.h without including
+    stdio.h.
+
 Changes in version 1.3.0 ("Ipomoea batatas"), released in December 2022:
   - New function: mpc_agm
   - New rounding modes "away from zero", indicated by the letter "A" and
diff --git a/src/balls.c b/src/balls.c
index ecaecd5..03a44a8 100644
--- a/src/balls.c
+++ b/src/balls.c
@@ -21,6 +21,7 @@ along with this program. If not, see http://www.gnu.org/licenses/ .
 #include "mpc-impl.h"
 
 
+#ifdef _GMP_H_HAVE_FILE
 void mpcb_out_str (FILE *f, mpcb_srcptr op)
 {
    mpc_out_str (f, 10, 0, op->c, MPC_RNDNN);
@@ -28,6 +29,7 @@ void mpcb_out_str (FILE *f, mpcb_srcptr op)
    mpcr_out_str (f, op->r);
    fprintf (f, "\n");
 }
+#endif
 
 
 void
diff --git a/src/mpc-impl.h b/src/mpc-impl.h
index a915751..3f46121 100644
--- a/src/mpc-impl.h
+++ b/src/mpc-impl.h
@@ -27,9 +27,6 @@ along with this program. If not, see http://www.gnu.org/licenses/ .
 #ifdef HAVE_STDLIB_H
 #include <stdlib.h>
 #endif
-#ifndef DONT_INCLUDE_STDIO
-#include <stdio.h>
-#endif
 #include "mpc.h"
 
 /*
diff --git a/src/radius.c b/src/radius.c
index 98ae8d5..88c7d71 100644
--- a/src/radius.c
+++ b/src/radius.c
@@ -18,7 +18,6 @@ You should have received a copy of the GNU Lesser General Public License
 along with this program. If not, see http://www.gnu.org/licenses/ .
 */
 
-#include <stdio.h>
 #include <math.h>
 #include <inttypes.h> /* for the PRIi64 format modifier */
 #include "mpc-impl.h"
@@ -405,6 +404,8 @@ int64_t mpcr_get_exp (mpcr_srcptr r)
    return MPCR_EXP (r) + 31;
 }
 
+
+#ifdef _GMP_H_HAVE_FILE
 void mpcr_out_str (FILE *f, mpcr_srcptr r)
 {
    if (mpcr_inf_p (r))
@@ -415,6 +416,7 @@ void mpcr_out_str (FILE *f, mpcr_srcptr r)
       fprintf (f, "Â±(%" PRIi64 ", %" PRIi64 ")", MPCR_MANT (r), MPCR_EXP (r));
    }
 }
+#endif
 
 
 static void mpcr_mul_rnd (mpcr_ptr r, mpcr_srcptr s, mpcr_srcptr t,
diff --git a/tests/teta.c b/tests/teta.c
index 1154d66..a8bb317 100644
--- a/tests/teta.c
+++ b/tests/teta.c
@@ -19,7 +19,7 @@ along with this program. If not, see http://www.gnu.org/licenses/ .
 */
 
 #include <math.h>
-#include "mpc-impl.h"
+#include "mpc-tests.h"
 
 static void
 mpcb_j_err (mpcb_ptr j, mpc_srcptr z, unsigned long int err_re,
-- 
GitLab

