# Description: PAM provides a way to develop programs that are independent of
# authentication scheme. These programs need "authentication modules" to be
# attatched to them at run-time in order to work. Which authentication module
# is to be attatched is dependent upon the local system setup and is at the
# discretion of the local system administrator.

pkgname=linux-pam
pkgver=1.5.2
pkgrel=4
pkgdesc="Linux PAM (Pluggable Authentication Modules for Linux)"
url="https://www.kernel.org/pub/linux/libs/pam"
arch="all"
license="BSD-3-Clause"
depends_dev="gettext-dev"
makedepends="$depends_dev bison flex-dev autoconf automake libtool linux-headers"
options="suid !check"
subpackages="$pkgname-dev $pkgname-doc"
source="
	https://github.com/linux-pam/linux-pam/releases/download/v$pkgver/Linux-PAM-$pkgver.tar.xz

	base-auth.pamd
	base-account.pamd
	base-password.pamd
	base-session.pamd
	base-session-noninteractive.pamd
	other.pamd
	system-local-login.pamd
	system-login.pamd
	su.pamd
	"
builddir="$srcdir"/Linux-PAM-$pkgver

# these had a /etc/pam.d/login
replaces="util-linux-login shadow-login"

# secfixes:
#   1.5.1-r0:
#     - CVE-2020-27780

prepare() {
	default_prepare
	# disable insecure modules
	sed -e 's/pam_rhosts//g' -i modules/Makefile.am

	autoreconf -vif
}

build() {
	[ "$CLIBC" = "musl" ] && export ac_cv_search_crypt=no
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--libdir=/usr/lib \
		--sbindir=/usr/sbin \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--disable-nls \
		--disable-db
	make
}

package() {
	make DESTDIR="$pkgdir" install

	# install our pam.d files
	for i in $source; do
		case $i in
		*.pamd)
			basename=$(echo $i | cut -d. -f1)
			install -Dm644 "$srcdir"/$i "$pkgdir"/etc/pam.d/"$basename"
			;;
		esac
	done

	# the "login" provided by util-linux/shadow requires a login pam.d
	install -Dm644 "$srcdir"/system-local-login.pamd \
		"$pkgdir"/etc/pam.d/login

	chgrp shadow "$pkgdir"/usr/sbin/unix_chkpwd \
		&& chmod g+s "$pkgdir"/usr/sbin/unix_chkpwd

	# we don't ship systemd
	rm -r "$pkgdir"/usr/lib/systemd
}

sha512sums="
fa16350c132d3e5fb82b60d991768fb596582639841b8ece645c684705467305ccf1302a0147ec222ab78c01b2c9114c5496dc1ca565d2b56bf315f29a815144  Linux-PAM-1.5.2.tar.xz
e209642a9fd81748f54125a9fb498db579d8aff7b864609c7263ee5753a83105d4a3e56745c2d6456851fde697e75c14a98e2e84bd3c8af974a12dba9d913cd8  base-auth.pamd
34e70b4e7fe0803b7e17a9b1e96319f48e1b566f45f7a85ee3eb97cc8882ed2e920208c45fde4bca38367de95e4cc6823590ac1aeb7a6d3ac0b8a5d0cfea933f  base-account.pamd
71ba5c53ef3cbdb7eb61c3d36653f750c9b5c7dd91f9b933ab0ea35f9913eac0031866ff684f352190b95b128dc751a86bf6335c1e62461de06ea7e8c1f004f2  base-password.pamd
143d02c093bdf3bdb19e0b063448bc09e9aa776d729ffafcee2975e1e1ce54efde22f05779ed9fc09b1caebe66ed0c77783536062f7e3e16994bf3b71975128e  base-session.pamd
df5718ddd16cd6c65ce1f193790f2b7bd26afcf57194e5aeb0e2893349dc22af27dbe1aa6749fee7643a87f809ae9c4e8ae8dcff9653e805ca0f371e3227092f  base-session-noninteractive.pamd
d4f11e176cbc6a1bde70096ac6b44895f9ce4f6d201bb6a8c812f452cceeac1a215835230ce894635325b2dc71e9d428b5d39663cacb9c3fc1c1281d0c165b2c  other.pamd
83cc3d84ef5afded9afd4d347132901b9adcbd8b21be45b80d010370a2082e8388a713eb78d052944bc47b07fd7383edf18e2674d9d0545215cc45e14a2e14b1  system-local-login.pamd
bb264a4db84aa4aa42d561bc0ca5db54034242a7ec0dcfd3df4b1900b2d80888c2e4ac0d0ed2ca3b503a320a464f1ed6658bb0a6346e6f82831b8e87cbfddcd8  system-login.pamd
9b3c860ee661be126a47445b3ed56d04df82f0b03fd4a8a8bbb8febf28985cd0704c7100b56a47f1b0f56bd639cbc1449df92e82cb098890fdeda023efcdb40a  su.pamd
"
