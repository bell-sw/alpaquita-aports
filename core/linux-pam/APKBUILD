# Description: PAM provides a way to develop programs that are independent of
# authentication scheme. These programs need "authentication modules" to be
# attatched to them at run-time in order to work. Which authentication module
# is to be attatched is dependent upon the local system setup and is at the
# discretion of the local system administrator.

pkgname=linux-pam
pkgver=1.5.3
pkgrel=1
pkgdesc="Linux PAM (Pluggable Authentication Modules for Linux)"
url="https://www.kernel.org/pub/linux/libs/pam"
arch="all"
license="BSD-3-Clause"
depends_dev="gettext-dev"
makedepends="
	$depends_dev
	autoconf
	automake
	bison
	flex-dev
	libtool
	linux-headers
	"
options="suid !check"
subpackages="$pkgname-dev $pkgname-doc"
source="
	https://github.com/linux-pam/linux-pam/releases/download/v$pkgver/Linux-PAM-$pkgver.tar.xz
	no-examples.patch

	base-auth.pamd
	base-account.pamd
	base-password.pamd
	base-session.pamd
	base-session-noninteractive.pamd
	login.pamd
	other.pamd
	system-local-login.pamd
	system-login.pamd
	su.pamd
	"
builddir="$srcdir"/Linux-PAM-$pkgver

# these had a /etc/pam.d/login
replaces="util-linux-login shadow-login"

# secfixes:
#   1.5.1-r0:
#     - CVE-2020-27780

build() {
	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--libdir=/usr/lib \
		--sbindir=/usr/sbin \
		--sysconfdir=/etc \
		--mandir=/usr/share/man \
		--infodir=/usr/share/info \
		--localstatedir=/var \
		--disable-nls \
		--disable-db
	make
}

package() {
	make DESTDIR="$pkgdir" install

	# install our pam.d files
	for i in $source; do
		case $i in
		*.pamd)
			basename=$(echo $i | cut -d. -f1)
			install -Dm644 "$srcdir"/$i "$pkgdir"/etc/pam.d/"$basename"
			;;
		esac
	done

	chgrp shadow "$pkgdir"/usr/sbin/unix_chkpwd \
		&& chmod g+s "$pkgdir"/usr/sbin/unix_chkpwd

	# wrong dir due to libdir
	mkdir -p "$pkgdir"/usr/lib
	mv "$pkgdir"/lib/pkgconfig "$pkgdir"/usr/lib/pkgconfig

	# we don't ship systemd
	rm -r "$pkgdir"/usr/lib/systemd
}

sha512sums="
af88e8c1b6a9b737ffaffff7dd9ed8eec996d1fbb5804fb76f590bed66d8a1c2c6024a534d7a7b6d18496b300f3d6571a08874cf406cd2e8cea1d5eff49c136a  Linux-PAM-1.5.3.tar.xz
9407f38d0dc0f24eb3e1c74ecc3ac78ddbe9f9882a4738fa82bfb387be30f5bff5599b11cb2d70705a299587697d967ddf57923b9bd0270d05f71cc5140f8d62  no-examples.patch
d5ad4dc80c892a6be190f5dad26013dab29c89e9735e3c67bfc897df7e6c55c7e220b4f9a4ab03af5f1dbeb47205042e94aab81f41addc9a8965012f5daebf2f  base-auth.pamd
697684befee830c3b60b618ad9b265ec6a5fc63447b03e626dc881f42438bed7402adb649546e852477441971dacc9d98d5974fc89fd74b57b24887258db0b93  base-account.pamd
ba4114b7e19cf71f71d1e16bebbdc5cff6ca78c6f43184fe076c8cb774186dea0f0d51cd9536147111b28355aaf722be48a1ea2040677d7916a9277ee78500fa  base-password.pamd
12a4a30bedb46c804ae5625578359a76f64cb8e5e2c8506c5396ad4ab2c7501c9923a94c5d33a664c645adf178bc3af1fe5d71abc7f0e4c2755e51ee24035720  base-session.pamd
fb1a6245e8c3618afc740d86549c9151e6992e886c7dc912fe084c8b9831e48b4635beab1e98afa9d1c794938c57cdcf111512201793a0f52838954923cd4543  base-session-noninteractive.pamd
de5a9aabdf22d65a0eebbe39b717ac68dbed5ab8ad3cfb05239d18cb61d16e4e1d6ded5ad95f4fbae32483753a7ee62645a1eccd15176bf2bb247ba6a0b7157d  login.pamd
d4f11e176cbc6a1bde70096ac6b44895f9ce4f6d201bb6a8c812f452cceeac1a215835230ce894635325b2dc71e9d428b5d39663cacb9c3fc1c1281d0c165b2c  other.pamd
83cc3d84ef5afded9afd4d347132901b9adcbd8b21be45b80d010370a2082e8388a713eb78d052944bc47b07fd7383edf18e2674d9d0545215cc45e14a2e14b1  system-local-login.pamd
bb264a4db84aa4aa42d561bc0ca5db54034242a7ec0dcfd3df4b1900b2d80888c2e4ac0d0ed2ca3b503a320a464f1ed6658bb0a6346e6f82831b8e87cbfddcd8  system-login.pamd
9b3c860ee661be126a47445b3ed56d04df82f0b03fd4a8a8bbb8febf28985cd0704c7100b56a47f1b0f56bd639cbc1449df92e82cb098890fdeda023efcdb40a  su.pamd
"
