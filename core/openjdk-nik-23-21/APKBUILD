# Description: $VENDOR_NAME $VENDOR_JAVA_NAME Native Image Kit is a versatile multilingual
# tool for accelerating your applications, based on GraalVM Open Source.

_java_pkgname=$(echo $VENDOR_JAVA_NAME | tr [:upper:] [:lower:])
_pkgname="${_java_pkgname}-nik"
_nikmajor=23
_javamajor=21

pkgname=$_pkgname-$_nikmajor-$_javamajor
pkgver=23.1.3
pkgrel=0

# java version required for the build
_javaver=21.0.3


# These are the tips of release/graal-vm/23.1 branches in
# the corresponding repositories as of 2024-04-10
_hash_graal="0e92f11f6952143e878ed713e1a7e0c31bacf05d"
_hash_graaljs="01c7595d92803e05247fed6389178c24c2763843"
_hash_graalpython="1a76fd3ccf5336ba462792448fa52c7bf3fa3bfb"
_hash_truffleruby="e86d3721c8ab04a0f64f394ecd457cf84a3f394d"
_date_truffleruby="2023-11-23"

# fastr doesn't have the $pkgver tags, so instead use the head of the
# corresponding release branch.
# HEAD of release/graal-vm/23.1 branch as of 2024-04-10
_hash_fastr="6d47efd1cf2bde0a1fa67b0c5bffb0e1312479f9"

# CI NIK builds just use master, but we need a fixed version for the
# package.  This is the latest tag along the master as of 2024-04-10
_mxver=7.22.0


pkgdesc="$VENDOR_JAVA_NAME Native Image Kit $pkgver (Java $_javamajor)"
url="$VENDOR_URL"
arch="x86_64"
license="GPL-2.0"
depends="
	$pkgname-core=$pkgver-r$pkgrel
	$pkgname-native-image=$pkgver-r$pkgrel
	"

makedepends="
	openjdk$_javamajor>=$_javaver
	openjdk$_javamajor-jmods>=$_javaver
	openjdk$_javamajor-libs-static>=$_javaver
	openjdk$_javamajor-src>=$_javaver

	bash
	bzip2-dev
	cmake
	coreutils
	curl-dev
	diffutils
	ed
	gfortran
	git
	grep
	linux-headers
	patch
	pcre-dev
	pcre2-dev
	perl
	python3
	py3-setuptools
	readline-dev
	sed
	unzip
	xz-dev
	yaml-dev
	z3-dev
	zlib-static
	"

options="!annobin !strip !check !tracedeps textrels ldpath-recursive"

subpackages="
	$pkgname-core:_core
	$pkgname-native-image:_native_image
	$pkgname-llvm-toolchain:_llvm_toolchain
	$pkgname-js:_js
	$pkgname-nodejs:_nodejs
	$pkgname-python:_python
	$pkgname-ruby:_ruby
	"

provides="openjdk-nik-$_nikmajor-$_javamajor=$pkgver-r$pkgrel"

_source_release="
	graal-vm-ce-$pkgver.tar.gz::https://github.com/oracle/graal/archive/refs/tags/vm-ce-$pkgver.tar.gz
	graaljs-vm-ce-$pkgver.tar.gz::https://github.com/oracle/graaljs/archive/refs/tags/vm-ce-$pkgver.tar.gz
	graalpython-vm-ce-$pkgver.tar.gz::https://github.com/oracle/graalpython/archive/vm-ce-$pkgver.tar.gz
	truffleruby-vm-$pkgver.tar.gz::https://github.com/oracle/truffleruby/archive/refs/tags/vm-$pkgver.tar.gz
	"

# for test builds, before the release is tagged
if test "$_hash_graal"; then
_source_release="
	graal-$pkgver-$_hash_graal.tar.gz::https://github.com/oracle/graal/archive/$_hash_graal.tar.gz
	graaljs-$pkgver-$_hash_graaljs.tar.gz::https://github.com/oracle/graaljs/archive/$_hash_graaljs.tar.gz
	graalpython-$pkgver-$_hash_graalpython.tar.gz::https://github.com/oracle/graalpython/archive/$_hash_graalpython.tar.gz
	truffleruby-$pkgver-$_hash_truffleruby.tar.gz::https://github.com/oracle/truffleruby/archive/$_hash_truffleruby.tar.gz
	"
fi

_source_release="$_source_release
	fastr-23.1-$_hash_fastr.tar.gz::https://github.com/oracle/fastr/archive/$_hash_fastr.tar.gz
	mx-$_mxver.tar.gz::https://github.com/graalvm/mx/archive/refs/tags/$_mxver.tar.gz
	"

_patches="
	graal-6814-mempool-max-value-exceeded.patch
	graal-copy-longs-intrinsics.patch
	graal-enable-awt-swing-substitute.patch
	graal-enable-awt-swing-suite-desktop.patch
	graal-enable-awt-swing-support.patch
	graal-enable-awt-swing.patch
	graal-fast-lock.patch
   musl:graal-musl-lfs64.patch
	graal-no-watchdog.patch
	graal-parallel-gc.patch
   musl:graal-relaunch-on-alpine.patch
	graal-restore-gu.patch
	graal-sdk-llvm-suite.patch
	graal-vendor-properties.patch

	graaljs-accept-python-3.12.patch
	graaljs-avoid-c++17.patch

	graalpython-graalpython-ssizet.patch

   musl:fastr-patch_fastr_musl_3_3.patch
	fastr-reduce-parallelism.patch

	truffleruby-allow-build-from-sources-out-of-the-vcs.patch
	truffleruby-musl-support.patch

	mx-mx-local-ninja.patch
	mx-mx_jardist_patch.patch
	mx-pass-cxxflags-to-ninja.patch

	mx-explain.patch
	"

source="
	$_source_release
	$_patches
	"

builddir="$srcdir"/$_pkgname-$pkgver
_java_home="/usr/lib/jvm/$pkgname"
ldpath="$_java_home/lib:$java_home/languages/python/lib-graalpython/lib"
sonameprefix="$pkgname:"

unpack() {
	default_unpack

	mkdir -p "$builddir"

	# rename the directories to their basenames, dropping git refs
	if ! test "$_hash_graal"; then
		mv graal-*$pkgver       "$builddir"/graal
		mv graaljs-*$pkgver     "$builddir"/graaljs
		mv graalpython-*$pkgver "$builddir"/graalpython
		mv truffleruby-*$pkgver "$builddir"/truffleruby
	else
		mv graal-$_hash_graal             "$builddir"/graal
		mv graaljs-$_hash_graaljs         "$builddir"/graaljs
		mv graalpython-$_hash_graalpython "$builddir"/graalpython
		mv truffleruby-$_hash_truffleruby "$builddir"/truffleruby
	fi

	# not in sync with the rest of them
	mv fastr-$_hash_fastr   "$builddir"/fastr

	# the build tool has its own tags
	mv mx-$_mxver           "$builddir"/mx
}

prepare() {
	default_prepare

	for p in graal graaljs graalpython truffleruby fastr mx ; do
		touch $p/.mx_vcs_root
	done
}


build() {
	export CFLAGS=
	export CXXFLAGS=
	export MX_PYTHON=python3
        export PATH=$(pwd)/mx:$PATH
	export JAVA_HOME=/usr/lib/jvm/$_java_pkgname$_javamajor
	export MX_CACHE_DIR=$SRCDEST/mx.cache
	export MX_NO_VCS=true

	cd graal/vm
	export DYNAMIC_IMPORTS=/substratevm
	export COMPONENTS=svm,nfi,gvm,poly
	export FORCE_BASH_LAUNCHERS=polyglot
	export SKIP_LIBRARIES=polyglot
	export SULONG_BOOTSTRAP_TOOLCHAIN_NO_HOME=/usr

	mx -V build
	mx graalvm-show
	mkdir ../../nik-core
	cp -aR $(mx graalvm-home)/* ../../nik-core/

	export TRUFFLERUBY_COMMIT_SHA="$_hash_truffleruby" # XXX
	export TRUFFLERUBY_COMMIT_DATE="$_date_truffleruby"
	export FASTR_RELEASE=true
	export FASTR_NO_RECOMMENDED=true
	export FASTR_BUNDLE_DEPENDENCIES=
	export FASTR_CAPTURE_DEPENDENCIES=
	export DYNAMIC_IMPORTS=/substratevm,/tools,/sulong,/graal-js,graal-nodejs,truffleruby,graalpython
	unset COMPONENTS=
	export DISABLE_INSTALLABLES=false
	export EXCLUDE_COMPONENTS=nju,nic,dis,pbm,llmulrl,lg,pbm,gwa
	export FORCE_BASH_LAUNCHERS=polyglot,polybench,truffleruby
	export SKIP_LIBRARIES=polyglot

	mx graalvm-show
	mx -V build
}

package() {
	mkdir -p "$pkgdir/$_java_home"
}

_make_symlinks() {
	local src dst dstdir

	# The "symlinks" files don't necessarily have the final
	# newline and that makes busybox "read" confused, so it
	# ignores the last line.  awk takes care of this, and since we
	# use it anyway to fix the newline problem, we might as well
	# use it to split symlinks lines into words.
	awk -e '{ print $1, $3 }'	\
	    "$1"/META-INF/symlinks	\
	| while read dst src; do
		dstdir="$(dirname "$dst")"
		[ -d "$1/$dstdir" ] || mkdir -p "$1/$dstdir"
		ln -s "$src" "$1/$dst"
	done
}

_core() {
	pkgdesc="$pkgname (Core)"
	depends="java-common"
	provides="openjdk-nik-$_nikmajor-$_javamajor-core=$pkgver-r$pkgrel"
	mkdir -p "$subpkgdir/$_java_home"
	cp -aR $builddir/nik-core/* "$subpkgdir/$_java_home/"
}

_native_image() {
	pkgdesc="pkgname (Native Image)"
	depends="$pkgname-core=$pkgver-r$pkgrel gcc libc-dev zlib-dev linux-headers"
	provides="openjdk-nik-$_nikmajor-$_javamajor-native-image=$pkgver-r$pkgrel"
	mkdir -p "$subpkgdir/$_java_home"
	unzip -qo "$builddir"/graal/sdk/mxbuild/linux-amd64/dists/native-image-installable-svm-java$_javamajor.jar -d "$subpkgdir/$_java_home/"
	_make_symlinks "$subpkgdir/$_java_home"
}

_llvm_toolchain() {
	pkgdesc="$pkgname (LLVM.org toolchain)"
	depends="$pkgname-native-image=$pkgver-r$pkgrel"
	provides="openjdk-nik-$_nikmajor-$_javamajor-llvm-toolchain=$pkgver-r$pkgrel"
	mkdir -p "$subpkgdir/$_java_home"
	unzip -qo "$builddir"/graal/sdk/mxbuild/linux-amd64/dists/llvm-toolchain-installable-ce-java$_javamajor.jar -d "$subpkgdir/$_java_home/"
	_make_symlinks "$subpkgdir/$_java_home"
}

_js() {
	pkgdesc="$pkgname (Graal.js)"
	depends="$pkgname-native-image=$pkgver-r$pkgrel"
	provides="openjdk-nik-$_nikmajor-$_javamajor-js=$pkgver-r$pkgrel"
	mkdir -p "$subpkgdir/$_java_home"
	unzip -qo "$builddir"/graal/sdk/mxbuild/linux-amd64/dists/js-installable-svm-java$_javamajor.jar -d "$subpkgdir/$_java_home/"
	_make_symlinks "$subpkgdir/$_java_home"
}

_nodejs() {
	pkgdesc="$pkgname (Graal.nodejs)"
	depends="$pkgname-native-image=$pkgver-r$pkgrel"
	provides="openjdk-nik-$_nikmajor-$_javamajor-nodejs=$pkgver-r$pkgrel"
	mkdir -p "$subpkgdir/$_java_home"
	unzip -qo "$builddir"/graal/sdk/mxbuild/linux-amd64/dists/nodejs-installable-svm-java$_javamajor.jar -d "$subpkgdir/$_java_home/"
	_make_symlinks "$subpkgdir/$_java_home"
}

_python() {
	pkgdesc="$pkgname (Graal.python)"
	depends="$pkgname-native-image=$pkgver-r$pkgrel"
	provides="openjdk-nik-$_nikmajor-$_javamajor-python=$pkgver-r$pkgrel"
	mkdir -p "$subpkgdir/$_java_home"
	unzip -qo "$builddir"/graal/sdk/mxbuild/linux-amd64/dists/python-installable-svm-java$_javamajor.jar -d "$subpkgdir/$_java_home/"
	# it's now languages/python/lib/python3.10/venv/scripts/nt/*.{bat,exe}
	# but it's in subdir, so I'm not sure why even bother with them
	# rm "$subpkgdir/$_java_home"/languages/python/lib-python/3/distutils/command/*.exe
	_make_symlinks "$subpkgdir/$_java_home"
}

_ruby() {
	pkgdesc="$pkgname (Graal.ruby)"
	depends="$pkgname-native-image=$pkgver-r$pkgrel $pkgname-llvm-toolchain=$pkgver-r$pkgrel"
	provides="openjdk-nik-$_nikmajor-$_javamajor-ruby=$pkgver-r$pkgrel"
	mkdir -p "$subpkgdir/$_java_home"
	unzip -qo "$builddir"/graal/sdk/mxbuild/linux-amd64/dists/ruby-installable-svm-java$_javamajor.jar -d "$subpkgdir/$_java_home/"
	_make_symlinks "$subpkgdir/$_java_home"
}

sha512sums="
ef4d734b5371c586378786aa074c92c32d4419f3458dc077fbb8b65ab471c4810c9b4af6ec94ce4142c04d498eddb8692d41670e21291ff46b86bff3f0becb5e  graal-23.1.3-0e92f11f6952143e878ed713e1a7e0c31bacf05d.tar.gz
922bd4f00d1a4dd5803ff778812c48494ebc9b0922d0a2800c8fd6dd37ac7e8b17cf0e2df2467dae85798f5e15ec4920becbfcc8feceaea4e2616fe3fc1a5ec1  graaljs-23.1.3-01c7595d92803e05247fed6389178c24c2763843.tar.gz
2424e9f1964f0560bd467d4f1b4ca7280e80f1f7ab96b00c41adfeb3b8f18912a6b9dd8311f06ffa1009cd721359738280721474265f5de05c4f0c8043a7b5ed  graalpython-23.1.3-1a76fd3ccf5336ba462792448fa52c7bf3fa3bfb.tar.gz
f10581bdd2990c88ad2681fb5ea5550769c5e28fb761898a98d65ed86faab8f2d30b93aecf87d514a8ddc0bbdea3778c17b81d5023397d00c34ca518c294650d  truffleruby-23.1.3-e86d3721c8ab04a0f64f394ecd457cf84a3f394d.tar.gz
9753206ec8cf0c1edeedb24d0db2de6bc96296352a15716ca0ecb218d55789a88bf042ea9f51bfb78c489f2afa5096ea51d9a7e17cbe3de0f26333c74f7c34f2  fastr-23.1-6d47efd1cf2bde0a1fa67b0c5bffb0e1312479f9.tar.gz
f7f791afd2262c96792fc72e08feb830a3fa830f6dbbc89ff853d300527a5649bbb9057e6b931eddf47428a0bf414a0abc356e3a02a412ace9487f343b66513d  mx-7.22.0.tar.gz
451cf642218e7a54965a596581979aaa4e9005c021589e8fac7d1e4b879794c8a0bdded554f78b10d6e8ced9ab597708d4e8c93f39234d70546095efc63a47d9  graal-6814-mempool-max-value-exceeded.patch
2424046d2a3e26987ea3902bd3e23a97ce969d66a74a29fe3b245f9360ce055ee12e6f15708f28e51f1ded3d16ca63ef1a1c1c8e02b0c23c1e34a5240fbee942  graal-copy-longs-intrinsics.patch
93b4c2ab486ce9dc262473d3a4f7cc6e2b7032ebb0bee57ba90774827d25453f9937c08f3e93f279c2d7beeaae93c388c0efa05876ad4d2c503aea486b6f3668  graal-enable-awt-swing-substitute.patch
13a3c701ceedbbce2d096fe760eda48c7884a2fd2fd04762ed83f2d895cc975428fd40aeaf5ee5d4454ff8acfc8899b96de4ee5238bab691ecf42d16b047ea35  graal-enable-awt-swing-suite-desktop.patch
bcfec4b86dbf525c5b2e6c3d1ba9ed2d3c9a84e7d45820946f6e5a6582d86747446e7d89a408217daa4a9032305f6ee131c095fe533e02c2a8773d10db75385c  graal-enable-awt-swing-support.patch
7ec154b912061a4d661d6427e96d0b63c2cbafccc591667be7abf84e1abe6c57b84028715275c73f014816de982507b8efba383cb46b0b8b22e478a7171a9008  graal-enable-awt-swing.patch
268627c3def272b827071879d812d9145260f1e8364449aadc3aeafb4cea7e62ca2f440dd4c37f27aa6790afb38a766876cc9bee0bd1b9b067c036b1ccf5d1eb  graal-fast-lock.patch
bb03fdc8ace4db429ac069cc67e95b2695e444dca9697b51b25e30b709c929e2e3d100be35cf73e41fd37dbf4300b5ad5b9682913a38330a3bf7b3adae2fdb2f  graal-musl-lfs64.patch
5a72f3e4806530e5fbd64c1b93fc731ffc68ce238745f2f0ae7d2d766f2332afb64c090321e221db741dc781b087aa1b515176e01462b257de49c7fb36423155  graal-no-watchdog.patch
c0172a2e7fb4d5be4cab61f7422c0159d2f40c3c1ea4fd6c2407770df4d31a27d68b6e7223c856f2989e7045c8ef8b10d0e550d498e50dce6d77a24832784486  graal-parallel-gc.patch
03d0fcef696d6ba1befc600c2be200c1df8362f47e00e08349d4d56f5372a95d713d5b239d0081818c37dbd20440e93b120538ddc1f9d605c6ffe8ebc9a433d3  graal-relaunch-on-alpine.patch
43aebff9ee03ecd6db74b1e69be689d61628abedbcbbbc59ef19db1fd6b49383d4e1242d7536a2458bd3d929faee117fb7d4a1fb6d249ac71c7e60d66543781c  graal-restore-gu.patch
cbd93ceb89a6f9b80f407d5185b1b383990457063cf4e38468ba3cfbd75fb28a08d6683cc3c490543243ba9488522b3579ca4abb12292ac6e42adb84938ce2ad  graal-sdk-llvm-suite.patch
c4928aae55059b3fa972962702522ce013f4f3b669e9ac98a031bcce8c15295e5cc42c2df881c5c639fb2d82b7c74131881a5683a6e135d9e3d3b530e5014019  graal-vendor-properties.patch
28bee3282b98dbba38a93bfd2d014a1dfd3dee215c36ec7556419576965648237a9de3cd7b70f53d137ba3884eaacf19765af7939330572eb7221b33cd29fe2c  graaljs-accept-python-3.12.patch
72ad929ddd0059a87ce5a9693d2705448c2d05dfcd52cbdcf75e1d6a740a3c9f5ae51ffc878fa6407c201a8b505860266e951100677f5cecd1aad658fa539aeb  graaljs-avoid-c++17.patch
3c09ff6173f701ba27e883af5e908fb3427bdeb52f6dceaeafed913a6f53c50e936c1315e348649cce60c667b15620d72f4143f3333b728425727c81bb26557b  graalpython-graalpython-ssizet.patch
fa4abc33be7105c72a67fbbf421c5d57c5f49eb5b9923e362439d592ff830b43cdfa9556cd75a8c56e4ca1ab086ae8cbca856b9bedba6328869e28c32cdc4c8a  fastr-patch_fastr_musl_3_3.patch
3174b1cc99e95f2eda274a8a68cb4f46399be5d3917292789390761b9a193185878c2427fa12caa99996d4f22476a93fae9b506384519c3ec12e4a2674f9c694  fastr-reduce-parallelism.patch
486cd3d50a256baa5484dc95140ce7c78a72b354f3c7f0d78a8ecf9282f3478fb617d4b5434ef6fd8a6d84143ac263e93e0b10c07f6c22387800cd97e74c8d72  truffleruby-allow-build-from-sources-out-of-the-vcs.patch
0f2988b955f234011814bf5b181d572742d859f26ab6674f7399bcb36064079836d02c1b767408ea58ad302d4e77cccd3179653484318125e9105510a6f77f1e  truffleruby-musl-support.patch
a348fb088066e16df165974073108b76325540f5366ccca477405d0e8eca1ea3294cac1a35073e26a8a8bdc5f5f628a05f0295fb01f3343a26456147041da009  mx-mx-local-ninja.patch
4b950e4f6d59989a507e434d3f9de672077e6cd6894ef332756f517695a4cb845507ef0238d08b92a067c16c1d585d5a9b9db4cb2c43a6943347d157f658c5b9  mx-mx_jardist_patch.patch
b0da5d44f0ec75ba1aaeb246e0eb7f7e0d6ee8b31e0cd6e65c22ef554c63a1698bf0d7ec11f3f26d9b7c0e666ed7f66b1df1cad6a687f8f0549c98d8979b6186  mx-pass-cxxflags-to-ninja.patch
2cdd58e3e04f5a4dfb74776115e1e094a40ca1c52698f656b62ac074b782ba3a261ce791b875288c5d9a5804b3ac56e7393fec9c9e8adfd7cc1f9a48d827d15a  mx-explain.patch
"
