# Description: glibc is a backward compatible and highly performant
# C library. The package includes core libraries with essential APIs
# for the GNU and Linux systems.

pkgname=glibc
pkgver=2.37.0
pkgrel=3
_glibcver=${pkgver%.*}
_patch_ver="glibc-2.37-38-gb752934602"
pkgdesc="GNU C Library"
url="https://www.gnu.org/software/libc"
arch="x86_64"
license="GPL-2.0 LGPL-2.0"
depends_dev="linux-headers"
makedepends="bison perl python3 texinfo gawk grep sed coreutils"
source="
	https://ftp.gnu.org/gnu/libc/glibc-$_glibcver.tar.xz
	${VENDOR_URL/\/\//\/\/packages.}${VENDOR_DISTRO}/distfiles/${_patch_ver}.patch.xz
	1000-delocalize-sh-scripts.patch
	ld.so.conf
	locale.gen.in
	locale-gen
	ldconfig.trigger.c
"
builddir="$srcdir/glibc-$_glibcver"
options="!libc_musl lib64 ldpath-recursive !check"
triggers="$pkgname-utils.trigger=/usr/lib:/usr/lib64:/usr/local/lib"
subpackages="
	$pkgname-dbg
	$pkgname-nscd
	$pkgname-utils
	$pkgname-locales::noarch
	$pkgname-doc
	$pkgname-dev
"

# secfixes:
#   2.37.0-r3:
#     - CVE-2023-4527
#   2.37.0-r0:
#     - CVE-2023-25139

build() {
	${CC:-${CROSS_COMPILE}gcc} ${CPPFLAGS} ${CFLAGS} \
		${LDFLAGS} "$srcdir"/ldconfig.trigger.c -o ldconfig.trigger

	mkdir glibc-build
	cd glibc-build

	echo "rootsbindir=/usr/sbin" >> configparms

	CFLAGS="-O3 -pipe -g"
	CPPFLAGS="$CFLAGS"
	LDFLAGS="-Wl,--as-needed,-O2,--sort-common"
	../configure \
		--host=$CHOST \
		--prefix=/usr \
		--libdir=/usr/lib \
		--enable-add-ons \
		--enable-bind-now \
		--enable-cet \
		--enable-kernel=3.10 \
		--enable-lock-elision \
		--enable-stack-protector=strong \
		--enable-stackguard-randomization \
		--enable-static-pie \
		--disable-profile \
		--disable-timezone-tools \
		--disable-werror \
		--with-bugurl="$VENDOR_BUG_REPORT_URL" \
		--with-pkgversion="$VENDOR_DISTRO_NAME Linux" \
		libc_cv_slibdir=/usr/lib
	make
}

check() {
	cd glibc-build
	make check
}

package() {
	install -D -m755 ldconfig.trigger $pkgdir/usr/sbin/ldconfig.trigger

	cd glibc-build

	install -dm755 "$pkgdir"/etc
	install -dm755 "$pkgdir"/usr/lib64

	make DESTDIR="$pkgdir" install

	rm -rf "$pkgdir"/var/db

	install -m644 "$srcdir"/ld.so.conf "$pkgdir"/etc/ld.so.conf

	install -m644 ../posix/gai.conf "$pkgdir"/etc/gai.conf

	ln -sf ../lib/ld-linux-x86-64.so.2 "$pkgdir"/usr/lib64/
	ln -sf usr/lib "$pkgdir"/lib
	ln -sf usr/lib64 "$pkgdir"/lib64
	ln -sf usr/sbin $pkgdir/sbin
}

locales() {
	depends="$pkgname-utils=$pkgver-r$pkgrel"
	pkgdesc="$pkgdesc (locales)"

	install -dm755 "$subpkgdir"/etc

	amove usr/share/locale
	amove usr/share/i18n

	mkdir "$subpkgdir"/usr/sbin
	install -m755 "$srcdir"/locale-gen "$subpkgdir"/usr/sbin/
	install -m644 "$srcdir"/locale.gen.in "$subpkgdir"/etc/locale.gen

	sed -e '1,3d' -e 's|/| |g' -e 's|\\| |g' -e 's|^|# |g' \
		"$builddir"/localedata/SUPPORTED >> "$subpkgdir"/etc/locale.gen

	grep -Ev "^(#|SUPPORTED-LOCALES)" "$builddir"/localedata/SUPPORTED | \
		tr -d '\' | tr '/' ' ' > "$subpkgdir"/usr/share/i18n/SUPPORTED
}

nscd() {
	depends="$pkgname-utils=$pkgver-r$pkgrel"
	pkgdesc="$pkgdesc (name service cache daemon)"

	install -dm755 "$subpkgdir"/usr/bin
	install -dm755 "$subpkgdir"/etc
	install -dm755 "$subpkgdir"/var/db/nscd

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/sbin/nscd "$subpkgdir"/usr/bin

	install -m644 "$builddir"/nscd/nscd.conf "$pkgdir"/etc/nscd.conf
}

utils() {
	pkgdesc="$pkgdesc (various programs)"
	depends=""

	amove usr/bin

	ln -sf usr/bin $subpkgdir/bin

	msg "Generating default locale C.UTF-8"

	mkdir -p $subpkgdir/usr/lib/locale
	I18NPATH=$builddir/localedata \
	$pkgdir/usr/lib/ld-linux-${CARCH/_/-}.so.2 --library-path $pkgdir/usr/lib \
	$subpkgdir/bin/localedef -i C -f UTF-8 \
		--prefix $subpkgdir \
		C.UTF-8
}

dev() {
	default_dev

	amove usr/lib/libc.so
	amove usr/lib/libm.so
}

sha512sums="
4fc5932f206bb1b8b54828a28af1a681616b838bbab60c81c82155f3629cbfe1301d271af65511ed917f4c6949a025429221fe6035753282f15346919f15b90c  glibc-2.37.tar.xz
11ebe6678504ec0886033d0aef9191ce77bddcd03443077c30736fb348f180632f8b7d8294c402cb201da0cb3d12d4bce3b28d5be0e77a26d5d2cd16bf18cfdf  glibc-2.37-38-gb752934602.patch.xz
2e6dbe2373c1b0e61413a23832f15a4a891aa3769afdff052ca5885f306c1ecc2ccd86f5c6fd5a91325809c59f7e39bb99e0afe1844eddf6c1fe22bf33cce657  1000-delocalize-sh-scripts.patch
73bfefd8a1366f3bc7bbfd3f34b599b49f48278f783eb2837a414eb914ac3ae9995fe4e9fec58b9d1da1eb6ed36ccc889257ffc54031f1731e041dc18e096e6f  ld.so.conf
47a686c2fda0f32a1e9e975f723ed96ab8125619541cf8711fa80d94428862be77c46d06f5ff17f6a978eb22c9f86929ee9bf79888e6f824beeb023f78512151  locale.gen.in
7f4e96d99f98da0074e8020efd574b5080b3364ba014e74c3fc262af685180f92a6a08f2681c0ce8b0b78a103cafe753943836943db20fe9064ad5f380b35de0  locale-gen
519f6d7fd227b2ceeda345bd2ca48146d961655fbff6a3d709d7726f64eef2ceedf55943b1e71b802b79309ef4dfe9b99251a5073a1c9169db3ac6a788b244d5  ldconfig.trigger.c
"
