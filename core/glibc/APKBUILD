# Description: glibc is a backward compatible and highly performant
# C library. The package includes core libraries with essential APIs
# for the GNU and Linux systems.

pkgname=glibc
pkgver=2.34.1
pkgrel=1
_glibcver=2.34
pkgdesc="GNU C Library"
url="https://www.gnu.org/software/libc"
arch="x86_64"
license="GPL-2.0 LGPL-2.0"
makedepends="bison perl python3 texinfo gawk grep sed coreutils"
source="
	https://ftp.gnu.org/gnu/libc/glibc-$_glibcver.tar.xz
	ld.so.conf
	locale.gen.in
	locale-gen
	nsswitch.conf
	0001-ldconfig-avoid-leak-on-empty-paths-in-config-file.patch
	0002-gconv_parseconfdir-Fix-memory-leak.patch
	0003-gaiconf_init-Avoid-double-free-in-label-and-preceden.patch
	0004-copy_and_spawn_sgid-Avoid-double-calls-to-close.patch
	0005-iconv_charmap-Close-output-file-when-done.patch
	0006-Linux-Fix-fcntl-ioctl-prctl-redirects-for-_TIME_BITS.patch
"
builddir="$srcdir/glibc-$_glibcver"
options="!libc_musl lib64 ldpath-recursive !check"
triggers="$pkgname-utils.trigger=/usr/lib:/usr/lib64:/usr/local/lib"
subpackages="
	$pkgname-nscd
	$pkgname-utils
	$pkgname-locales::noarch
	$pkgname-doc
	$pkgname-dev
"


build() {
	mkdir glibc-build
	cd glibc-build

	echo "rootsbindir=/usr/sbin" >> configparms

	CFLAGS="-O2 -pipe"
	CPPFLAGS="$CFLAGS"
	LDFLAGS="-Wl,--as-needed,-O2,--sort-common"
	../configure \
		--host=$CHOST \
		--prefix=/usr \
		--libdir=/usr/lib \
		--enable-add-ons \
		--enable-bind-now \
		--enable-cet \
		--enable-kernel=4.4 \
		--enable-lock-elision \
		--enable-stack-protector=strong \
		--enable-stackguard-randomization \
		--enable-static-pie \
		--disable-profile \
		--disable-timezone-tools \
		--disable-werror \
		--with-bugurl=https://bell-sw.com/support/ \
		--with-pkgversion='Alpaquita Linux' \
		libc_cv_slibdir=/usr/lib
	make
}

check() {
	cd glibc-build
	make check
}

package() {
	cd glibc-build

	install -dm755 "$pkgdir"/etc
	install -dm755 "$pkgdir"/usr/lib64
 
	make DESTDIR="$pkgdir" install

	rm -rf "$pkgdir"/var/db

	install -m644 "$srcdir"/ld.so.conf "$pkgdir"/etc/ld.so.conf
	install -m644 "$srcdir"/nsswitch.conf "$pkgdir"/etc/nsswitch.conf

	install -m644 ../posix/gai.conf "$pkgdir"/etc/gai.conf

	ln -sf ../lib/ld-linux-x86-64.so.2 "$pkgdir"/usr/lib64/
	ln -sf usr/lib "$pkgdir"/lib
	ln -sf usr/lib64 "$pkgdir"/lib64
	ln -sf usr/sbin $pkgdir/sbin
}

locales() {
	depends="$pkgname-utils=$pkgver-r$pkgrel"
	pkgdesc="$pkgdesc (locales)"

	install -dm755 "$subpkgdir"/etc

	amove usr/share/locale
	amove usr/share/i18n
	
	mkdir "$subpkgdir"/usr/sbin
	install -m755 "$srcdir"/locale-gen "$subpkgdir"/usr/sbin/
	install -m644 "$srcdir"/locale.gen.in "$subpkgdir"/etc/locale.gen

	sed -e '1,3d' -e 's|/| |g' -e 's|\\| |g' -e 's|^|#|g' \
		"$builddir"/localedata/SUPPORTED >> "$subpkgdir"/etc/locale.gen
}

nscd() {
	depends="$pkgname-utils=$pkgver-r$pkgrel"
	pkgdesc="$pkgdesc (name service cache daemon)"

	install -dm755 "$subpkgdir"/usr/bin
	install -dm755 "$subpkgdir"/etc
	install -dm755 "$subpkgdir"/var/db/nscd

	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/sbin/nscd "$subpkgdir"/usr/bin

	install -m644 "$builddir"/nscd/nscd.conf "$pkgdir"/etc/nscd.conf
}

utils() {
	pkgdesc="$pkgdesc (various programs)"
	depends=""

	amove usr/bin

	ln -sf usr/bin $subpkgdir/bin

	msg "Generating default locale C.UTF-8"

	mkdir -p $subpkgdir/usr/lib/locale
	$subpkgdir/bin/localedef \
		-i $builddir/localedata/locales/POSIX \
		-f $builddir/localedata/charmaps/UTF-8 \
		--prefix $subpkgdir \
		C.UTF-8 || true
}

sha512sums="
15252affd9ef4523a8001db16d497f4fdcb3ddf4cde7fe80e075df0bd3cc6524dc29fbe20229dbf5f97af580556e6b1fac0de321a5fe25322bc3e72f93beb624  glibc-2.34.tar.xz
73bfefd8a1366f3bc7bbfd3f34b599b49f48278f783eb2837a414eb914ac3ae9995fe4e9fec58b9d1da1eb6ed36ccc889257ffc54031f1731e041dc18e096e6f  ld.so.conf
47a686c2fda0f32a1e9e975f723ed96ab8125619541cf8711fa80d94428862be77c46d06f5ff17f6a978eb22c9f86929ee9bf79888e6f824beeb023f78512151  locale.gen.in
7f4e96d99f98da0074e8020efd574b5080b3364ba014e74c3fc262af685180f92a6a08f2681c0ce8b0b78a103cafe753943836943db20fe9064ad5f380b35de0  locale-gen
3a871c970f7cdf35637e8d10da5c9ab64f9ccf949873e085f9ecdbf5696e6463698e09097e30eabb417eed050ba37d598fe9544607869993f6da3335c91e9f0e  nsswitch.conf
dd1d36d70f0a3939145f4647ac423fa1c4347353662ad48a6479a0e7217104fac6e759edbd7c0434b6fa568754f1d38165f7eac53410b54d498fabfbc5e45d5a  0001-ldconfig-avoid-leak-on-empty-paths-in-config-file.patch
bfccc195d49309c0e3010cb6d711fee12bc91e96539f9cfb17e9835cd7a031590f46a5370bc2b28e62a72e28062affcd6e1c62119400c569b7933859ff2bd542  0002-gconv_parseconfdir-Fix-memory-leak.patch
d2a85c8b3e8351f317448e00e0282b1bddaa99b5cc2d59ee7387b36024b760a50aa2426b5625decfe936051ab01e5f79c94f21672c74f913ea18eaf006f06475  0003-gaiconf_init-Avoid-double-free-in-label-and-preceden.patch
af027f3e93e643ce0d165935aa4be96b7f87b5edfb5b120bef133822c2b5763d25cbddc087e16152b1400f2e68c60a97048d22f006d3b25f592326b8d9235290  0004-copy_and_spawn_sgid-Avoid-double-calls-to-close.patch
6ebbd86bb7b3a9d4abb9f14acd23e35273cee09cb6951e91062207d44ed0cfc2c6e058c97c403b5619bfdab42ad7aefb51f52bccd1dadd2a907fdb81253305df  0005-iconv_charmap-Close-output-file-when-done.patch
5fba0b0ffc3d6306c52fe72e64574a862c4d815717e69534c91875edbd57f6fc7e47283d4c83643d536378c107886cb2221c13043f49159d4ae7890ed9bcec16  0006-Linux-Fix-fcntl-ioctl-prctl-redirects-for-_TIME_BITS.patch
"
