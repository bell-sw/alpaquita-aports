# Description: apk-tools provides instruments to work with packages:
# install, upgrade, or delete them.

pkgname=apk-tools
pkgver=2.14.0
pkgrel=3
pkgdesc="APK Package Manager (Derivative from Alpine Package Keeper)"
arch="all"
url="https://gitlab.alpinelinux.org/alpine/apk-tools"
license="GPL-2.0-only"
subpackages="$pkgname-dbg $pkgname-dev $pkgname-doc $pkgname-zsh-completion"
makedepends_build="openssl>3 lua5.3 lua5.3-lzlib scdoc"
makedepends_host="zlib-dev openssl-dev>3 linux-headers"
makedepends="$makedepends_build $makedepends_host"
_lua="no"
if [ "$CBUILD" = "$CHOST" ]; then
	_lua="lua5.3"
	subpackages="$subpackages $_lua-apk:luaapk"
	makedepends="$makedepends $_lua-dev"

	# ca-certificates-bundle needed for https certificate validation
	depends="$depends ca-certificates-bundle"
fi
source="https://gitlab.alpinelinux.org/alpine/apk-tools/-/archive/v$pkgver/apk-tools-v$pkgver.tar.gz
	_apk
	0001-Get-rid-of-separation-of-sbin-lib-and-their-usr-coun.patch
	0002-add-alternative-packages-support.patch
	0003-commit-make-the-installing-of-alternative-packages-s.patch
	0004-alternative-packages-tests.patch
	0005-solver-clean-db-when-removing-alternative-pkg.patch
	0006-support-gradual-downgrade-with-apk-add.patch
	0007-apk-search-sorted-output.patch
	0008-reset-sigpipe-handler-to-default-when-running-script.patch
	0009-retry-fetch-on-http-timeout-errors.patch
	"
builddir="$srcdir/$pkgname-v$pkgver"

# secfixes:
#   2.12.6-r0:
#     - CVE-2021-36159
#   2.12.5-r0:
#     - CVE-2021-30139

prepare() {
	default_prepare
	sed -i -e 's:-Werror::' Make.rules
	echo "FULL_VERSION=$pkgver-r$pkgrel" > config.mk
}

build() {
	make LUA="$_lua"
}

check() {
	make check LUA="$_lua"
}

package() {
	make DESTDIR="$pkgdir" LUA="$_lua" install
	install -d "$pkgdir"/var/lib/apk \
		"$pkgdir"/lib/apk/exec \
		"$pkgdir"/etc/apk/keys \
		"$pkgdir"/etc/apk/protected_paths.d

	install -Dm644 "$srcdir"/_apk "$pkgdir"/usr/share/zsh/site-functions/_apk
	rm -r "$pkgdir"/usr/share/doc
}

luaapk() {
	pkgshortdesc="Lua module for apk-tools"
	amove usr/lib/lua
}

sha512sums="
95bfc6d4210c3fb0cd0226b01a67610d719bdf88574c4159b15594c379fa63a7aea88dbeba435af6920e68e65547c9472f987c53589d5f5cc3e1e1280ee8c227  apk-tools-v2.14.0.tar.gz
7870676720f5007eee9482786e02246f8e3474afb90e76c9c83aebe914747a8e007b5d2eed6441933f4922024b3f0664db270f21981ad6c2db877a110b0cd79e  _apk
a81ad0f23d1b4ed0484332cf00b894144e1d96761ec119e36507625d75e83d406c8db28d805d24ba859b28b21946bf5a0878874b7c1275bcfa9ed15fc8feeae7  0001-Get-rid-of-separation-of-sbin-lib-and-their-usr-coun.patch
f2329a7d5c29d16f98e165b85451a2be31935ee79bc6809f2681a1b22b000e10b4573f515be32557aa06db280d8cf81ca522646fe184ed310114c653fbf21873  0002-add-alternative-packages-support.patch
42cffa54c55d763ef7e714df358f760afda0d429d5c9cb615acac569a9611bbbd9a347bd44382690dc7d4e77ffd93c838d20809edc492d897c7fdfbbeee95077  0003-commit-make-the-installing-of-alternative-packages-s.patch
d70561e5d71a1503363c65181ad02a7c7cc80fbd6702d33ff9c7b3b1f75c08e32b25ea0a47187aba4a1e5bd121453d5d93b33fc6a1af75917860716d921af5f1  0004-alternative-packages-tests.patch
a434b9c96c8d65f95e9141adeb5743b0da09ef43ebbd4a80fff9e3f826762be9343d3fac4ed2a3ee45195f50fc7fbfcc07f648c6078c9007e086f2dad494e0cd  0005-solver-clean-db-when-removing-alternative-pkg.patch
d4b501a9ebff49ea6aa6dfb62986faf6a36a369a90e95ee54d9f98525c3278e5c2806bae36651c4e41e2af39073f040abddf3d08f6b852c5910675b58967b2e3  0006-support-gradual-downgrade-with-apk-add.patch
be2d7ae6d37a849ba14a328a0e9a2a39c69fbcb1abe345e5de39b48970905359f7ec9f46d52a1a42ba0ac8942538eca4951fd088bf9f8c3179e71ebdb07bed3b  0007-apk-search-sorted-output.patch
5313f4f6be3c0965efebf05bc63fadb2771e6d89853a1ca0daa6c0240e6bcda5e8553c76c82a7040a5dd913d509eb67977607b94d58bf1e4f0685eac1648fe1c  0008-reset-sigpipe-handler-to-default-when-running-script.patch
4304c18ce7f6ce2e1dc16efca150296b65feaf05b4522549db90fe92a5c5b0298ee3da42d062c58505de7d26fb401dd4306e5457fb721e96a04887fe2d50e550  0009-retry-fetch-on-http-timeout-errors.patch
"
