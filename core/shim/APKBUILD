pkgname=shim
pkgver=15.5
pkgrel=0
pkgdesc="shim, a first-stage UEFI bootloader"
url="https://github.com/rhboot/shim"
arch="x86_64"
license="BSD-2-Clause-Patent"
makedepends="gcc make elfutils-dev xxd dos2unix efivar-dev"
source="https://github.com/rhboot/shim/releases/download/$pkgver/shim-$pkgver.tar.bz2
	bellsoft-uefi-ca.der
	sbat.alpaquita.csv

	0001-MokManager-removed-Locate-graphic-output-protocol-fa.patch
	0002-mock-variables.c-fix-gcc-warning.patch
	0003-test-str.c-fix-gcc-warnings-with-FORTIFY_SOURCE-enab.patch
"
builddir="$srcdir/$pkgname-$pkgver"
subpackages="$pkgname-utils $pkgname-dbg"
options="!libc_musl !stackprot !annobin"

prepare() {
	default_prepare
	cp "$srcdir"/bellsoft-uefi-ca.der "$builddir"/

	sed "s,@VERSION@,$pkgver-r$pkgrel," < "$srcdir"/sbat.alpaquita.csv \
		> "$builddir"/data/sbat.alpaquita.csv
	msg "Alpaquita .sbat section: $(cat $builddir/data/sbat.alpaquita.csv)"
}

build() {
	make VENDOR_CERT_FILE=bellsoft-uefi-ca.der
}

package() {
	make VENDOR_CERT_FILE=bellsoft-uefi-ca.der \
	     DESTDIR=$pkgdir \
	     EFIDIR=alpaquita \
	     install
}

utils() {
	local lib_path="$subpkgdir/usr/lib/shim"

	mkdir -p $lib_path
	cp "$pkgdir"/boot/efi/EFI/alpaquita/* $lib_path
	cp "$pkgdir"/boot/efi/EFI/BOOT/* $lib_path
	cp "$srcdir"/bellsoft-uefi-ca.der $lib_path
}

dbg()
{
	mv "$pkgdir"/usr "$subpkgdir"
}

check() {
	make test
}

sha512sums="
91fbda1ef0b4ea36538b57179488169f37eb8522d8dbbbf2eeb40708bc013073b4454b4205a957df13e1e15b9151c6013a8292691f9e3ab28ba7d0935fcc4fab  shim-15.5.tar.bz2
8a546ec87f2796b860531e3a45ea55142b8cc266af0f44d8d433470e35added37bc938cd4f309d1966c165a066b3aae3633f75cc43a62ab011ab99ea416efb20  bellsoft-uefi-ca.der
b73df23865c9ae95c0b5bdc300fbfbba780681d7ccc9aa5ceaf62ede92e0888681940b6c2611c73ed30ed56878fa5a4c303afce8be12bc27279c83b7bb3d4298  sbat.alpaquita.csv
92bd06c4c146cd560c7eb1675c488d816002ad79374b0bb1a117db3dfa2c65dc6578b2706869a203640529a9624e774f0194687b3f14248e6ad75a90516751a2  0001-MokManager-removed-Locate-graphic-output-protocol-fa.patch
84b5a934cd016a01c3b7e51132e7652fbd304bf1098220e67c0bd14ef3788ba0c05aba6593cb81fee34a772bfd636f3e85d8a6e200102b37fadabf9587a189bd  0002-mock-variables.c-fix-gcc-warning.patch
2ba90177a7b336520649645310d521c536fa67a6c1f8f6114468a96cc7bc1087cb9cd0d955a18a46d052f3aeb24ef075cdc366fee817981e8761e0f018f5ece7  0003-test-str.c-fix-gcc-warnings-with-FORTIFY_SOURCE-enab.patch
"
